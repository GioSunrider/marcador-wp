<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - Marcador de Waterpolo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0a2463 0%, #1a3d7a 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: rgba(0, 30, 80, 0.8);
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            color: #fff;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .title-edit-controls {
            margin-top: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        .title-edit-controls .edit-input {
            max-width: 400px;
            flex-grow: 1;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: #3e92cc;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2a7db5;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .btn-secondary {
            background-color: #ff6b6b;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #ff5252;
            transform: translateY(-3px);
        }
        
        .btn-success {
            background-color: #4ecdc4;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #3db8af;
            transform: translateY(-3px);
        }
        
        .btn-warning {
            background-color: #ffd166;
            color: #333;
        }
        
        .btn-warning:hover {
            background-color: #ffc145;
            transform: translateY(-3px);
        }
        
        .btn-preset {
            background-color: rgba(255, 255, 255, 0.15);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            min-width: 120px;
            justify-content: center;
        }
        
        .btn-preset:hover {
            background-color: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
        }
        
        .btn-preset.active {
            background-color: #4ecdc4;
            border-color: #4ecdc4;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .panel {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .panel-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #ffd166;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 10px;
        }
        
        .team-header {
            margin-bottom: 25px;
        }
        
        .team-name {
            font-size: 2rem;
            margin-bottom: 15px;
            font-weight: 700;
            color: #fff;
        }
        
        .team-logo {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
            border: 5px solid rgba(255, 255, 255, 0.3);
            overflow: hidden;
        }
        
        .logo-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .logo-placeholder {
            font-size: 2.5rem;
        }
        
        .score-section {
            margin-bottom: 25px;
        }
        
        .score {
            font-size: 5rem;
            font-weight: 800;
            color: #ffd166;
            text-shadow: 0 3px 10px rgba(0, 0, 0, 0.4);
            margin: 10px 0;
        }
        
        .score-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }
        
        .score-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 1.8rem;
            font-weight: bold;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .score-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .timeouts-section {
            margin-top: 25px;
        }
        
        .timeouts-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #ffd166;
        }
        
        .timeouts-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .timeout-box {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .timeout-used {
            background-color: #ff6b6b;
        }
        
        .timeout-btn {
            padding: 10px 20px;
            border-radius: 50px;
            border: none;
            background-color: #ff6b6b;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .timeout-btn:hover {
            background-color: #ff5252;
            transform: translateY(-3px);
        }
        
        .timer-display {
            font-size: 5rem;
            font-weight: 800;
            color: #4ecdc4;
            margin: 20px 0;
            text-shadow: 0 3px 10px rgba(0, 0, 0, 0.4);
            font-family: 'Courier New', monospace;
        }
        
        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .timer-presets {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .preset-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        .preset-input-group {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 5px;
        }
        
        .edit-time-input {
            width: 70px;
            padding: 8px;
            border-radius: 8px;
            border: 2px solid #3e92cc;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1.1rem;
            text-align: center;
        }
        
        .edit-time-input-small {
            width: 60px;
            padding: 6px;
            font-size: 1rem;
        }
        
        .edit-time-input-tiny {
            width: 50px;
            padding: 5px;
            font-size: 0.9rem;
        }
        
        .preset-save-btn {
            padding: 6px 10px;
            border-radius: 50%;
            border: none;
            background-color: rgba(78, 205, 196, 0.3);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }
        
        .preset-save-btn:hover {
            background-color: rgba(78, 205, 196, 0.5);
        }
        
        .edit-input {
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #3e92cc;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            width: 100%;
            max-width: 300px;
            margin-bottom: 10px;
        }
        
        .edit-team-form {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }
        
        .edit-timeout-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
        }
        
        .edit-timeout-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .edit-timeout-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .unified-timer-panel {
            grid-column: span 2;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
        }
        
        .timer-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-top: 30px;
        }
        
        .timer-section {
            text-align: center;
        }
        
        .timer-label {
            font-size: 1.5rem;
            margin-bottom: 10px;
            color: #ffd166;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .game-timer-edit {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .time-input-group {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .time-separator {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4ecdc4;
        }
        
        .unified-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .period-control {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 25px;
            justify-content: center;
        }
        
        .period-display {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffd166;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 8px 20px;
            border-radius: 50px;
        }
        
        .window-controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
            align-items: center;
        }
        
        .timer-settings {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 25px;
            background-color: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 10px;
        }
        
        .setting-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        
        .sync-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            padding: 10px;
            background-color: rgba(78, 205, 196, 0.2);
            border-radius: 10px;
            border: 1px solid rgba(78, 205, 196, 0.5);
        }
        
        .sync-icon {
            color: #4ecdc4;
            font-size: 1.2rem;
            animation: pulse 2s infinite;
        }
        
        .custom-time-control {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .auto-pause-notice {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            padding: 10px;
            background-color: rgba(255, 107, 107, 0.2);
            border-radius: 10px;
            border: 1px solid rgba(255, 107, 107, 0.5);
            font-size: 0.9rem;
        }
        
        .auto-pause-icon {
            color: #ff6b6b;
            font-size: 1rem;
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .unified-timer-panel {
                grid-column: span 1;
            }
            
            .timer-container {
                grid-template-columns: 1fr;
                gap: 30px;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .timer-display {
                font-size: 4rem;
            }
            
            .score {
                font-size: 4rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .unified-controls {
                flex-direction: column;
            }
            
            .game-timer-edit {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-water"></i> Panel de Control - Marcador de Waterpolo</h1>
            <p class="subtitle">Control avanzado de temporizadores - Pausa automática al terminar posesión</p>
            
            <div class="title-edit-controls">
                <input type="text" class="edit-input" id="publicTitleInput" placeholder="Ej: Liga Nacional - Jornada 5">
                <button class="btn btn-primary" id="savePublicTitleBtn" style="padding: 8px 15px;">
                    <i class="fas fa-save"></i> Guardar Título
                </button>
            </div>
            
            <div class="controls">
                <button class="btn btn-primary" id="publicViewBtn">
                    <i class="fas fa-tv"></i> Abrir Vista Pública
                </button>
                <button class="btn btn-warning" id="resetAllBtn">
                    <i class="fas fa-redo"></i> Reiniciar Todo
                </button>
            </div>
            <div class="window-controls">
                <button class="btn btn-success" id="possession1WindowBtn">
                    <i class="fas fa-stopwatch"></i> Ventana Posesión 1
                </button>
                <button class="btn btn-success" id="possession2WindowBtn">
                    <i class="fas fa-stopwatch"></i> Ventana Posesión 2
                </button>
            </div>
            <div class="sync-indicator">
                <i class="fas fa-sync-alt sync-icon"></i>
                <span>Temporizadores sincronizados - Pausa automática al 0</span>
            </div>
            <div class="auto-pause-notice">
                <i class="fas fa-exclamation-circle auto-pause-icon"></i>
                <span>Cuando la posesión llegue a 0, ambos temporizadores se pausarán automáticamente</span>
            </div>
        </header>
        
        <div class="main-content">
            <!-- Equipo Local -->
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-home"></i> Equipo Local</h2>
                
                <div class="team-header">
                    <div class="team-logo" id="localLogo">
                        <i class="fas fa-swimmer logo-placeholder"></i>
                    </div>
                    <div class="team-name" id="localName">LOCAL</div>
                </div>
                
                <div class="score-section">
                    <div class="score" id="localScore">0</div>
                    <div class="score-controls">
                        <button class="score-btn" id="localMinus">-</button>
                        <button class="score-btn" id="localPlus">+</button>
                    </div>
                </div>
                
                <div class="timeouts-section">
                    <div class="timeouts-title">Tiempos Muertos</div>
                    <div class="timeouts-controls">
                        <div class="timeout-box" id="localTimeout1">1</div>
                        <div class="timeout-box" id="localTimeout2">2</div>
                    </div>
                    <div class="edit-timeout-controls">
                        <button class="edit-timeout-btn" id="localTimeoutAdd">
                            <i class="fas fa-plus"></i>
                        </button>
                        <span>Usados: <span id="localTimeoutsUsed">0</span>/2</span>
                        <button class="edit-timeout-btn" id="localTimeoutRemove">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                
                <div class="edit-team-form">
                    <input type="text" class="edit-input" id="localNameInput" placeholder="Nombre del equipo local">
                    <input type="text" class="edit-input" id="localLogoInput" placeholder="URL del escudo (opcional)">
                    <button class="btn btn-primary" id="saveLocalBtn">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                </div>
            </div>
            
            <!-- Equipo Visitante -->
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-plane-departure"></i> Equipo Visitante</h2>
                
                <div class="team-header">
                    <div class="team-logo" id="visitorLogo">
                        <i class="fas fa-water logo-placeholder"></i>
                    </div>
                    <div class="team-name" id="visitorName">VISITANTE</div>
                </div>
                
                <div class="score-section">
                    <div class="score" id="visitorScore">0</div>
                    <div class="score-controls">
                        <button class="score-btn" id="visitorMinus">-</button>
                        <button class="score-btn" id="visitorPlus">+</button>
                    </div>
                </div>
                
                <div class="timeouts-section">
                    <div class="timeouts-title">Tiempos Muertos</div>
                    <div class="timeouts-controls">
                        <div class="timeout-box" id="visitorTimeout1">1</div>
                        <div class="timeout-box" id="visitorTimeout2">2</div>
                    </div>
                    <div class="edit-timeout-controls">
                        <button class="edit-timeout-btn" id="visitorTimeoutAdd">
                            <i class="fas fa-plus"></i>
                        </button>
                        <span>Usados: <span id="visitorTimeoutsUsed">0</span>/2</span>
                        <button class="edit-timeout-btn" id="visitorTimeoutRemove">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                
                <div class="edit-team-form">
                    <input type="text" class="edit-input" id="visitorNameInput" placeholder="Nombre del equipo visitante">
                    <input type="text" class="edit-input" id="visitorLogoInput" placeholder="URL del escudo (opcional)">
                    <button class="btn btn-primary" id="saveVisitorBtn">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                </div>
            </div>
            
            <!-- Panel Unificado de Temporizadores -->
            <div class="panel unified-timer-panel">
                <h2 class="panel-title"><i class="fas fa-clock"></i> Control de Temporizadores</h2>
                
                <div class="timer-container">
                    <!-- Temporizador de Partido -->
                    <div class="timer-section">
                        <div class="timer-label">
                            <i class="fas fa-gamepad"></i>
                            <span>Tiempo de Partido</span>
                        </div>
                        <div class="timer-display" id="gameTimerDisplay">08:00</div>
                        
                        <!-- Edición exacta del tiempo de partido -->
                        <div class="game-timer-edit">
                            <div class="time-input-group">
                                <input type="number" class="edit-time-input edit-time-input-tiny" id="gameMinutesInput" min="0" max="99" value="8">
                                <span class="time-separator">:</span>
                                <input type="number" class="edit-time-input edit-time-input-tiny" id="gameSecondsInput" min="0" max="59" value="0">
                            </div>
                            <button class="btn btn-primary" id="setGameTimeBtn" style="padding: 8px 15px;">
                                <i class="fas fa-check"></i> Establecer
                            </button>
                        </div>
                        
                        <div class="period-control">
                            <button class="btn btn-warning" id="prevPeriodBtn">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div class="period-display" id="periodDisplay">PERIODO 1</div>
                            <button class="btn btn-warning" id="nextPeriodBtn">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Temporizador de Posesión -->
                    <div class="timer-section">
                        <div class="timer-label">
                            <i class="fas fa-stopwatch"></i>
                            <span>Tiempo de Posesión</span>
                        </div>
                        <div class="timer-display" id="possessionDisplay">30</div>
                        
                        <!-- Presets editables -->
                        <div class="timer-presets">
                            <div class="preset-container">
                                <button class="btn btn-preset active" id="preset30Btn">
                                    <span id="preset30Text">30</span>s
                                </button>
                                <div class="preset-input-group">
                                    <input type="number" class="edit-time-input edit-time-input-small" id="preset30Input" min="5" max="60" value="30">
                                    <button class="preset-save-btn" id="savePreset30Btn" title="Guardar valor">
                                        <i class="fas fa-check"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <div class="preset-container">
                                <button class="btn btn-preset" id="preset20Btn">
                                    <span id="preset20Text">20</span>s
                                </button>
                                <div class="preset-input-group">
                                    <input type="number" class="edit-time-input edit-time-input-small" id="preset20Input" min="5" max="60" value="20">
                                    <button class="preset-save-btn" id="savePreset20Btn" title="Guardar valor">
                                        <i class="fas fa-check"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tiempo personalizado -->
                        <div class="custom-time-control">
                            <div class="setting-group">
                                <span>Tiempo personalizado:</span>
                                <input type="number" class="edit-time-input edit-time-input-small" id="possessionCustomTime" min="5" max="60" value="30">
                                <button class="btn btn-primary" id="setCustomTimeBtn" style="padding: 8px 15px;">
                                    <i class="fas fa-check"></i> Aplicar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Controles Unificados -->
                <div class="unified-controls">
                    <button class="btn btn-primary" id="startAllBtn">
                        <i class="fas fa-play"></i> Iniciar Ambos
                    </button>
                    <button class="btn btn-secondary" id="pauseAllBtn">
                        <i class="fas fa-pause"></i> Pausar Ambos
                    </button>
                    <button class="btn btn-success" id="resetAllTimersBtn">
                        <i class="fas fa-redo"></i> Reiniciar Ambos
                    </button>
                </div>
                
                <!-- Ajustes de Temporizadores -->
                <div class="timer-settings">
                    <div class="setting-group">
                        <span>Duración del periodo:</span>
                        <input type="number" class="edit-time-input edit-time-input-small" id="periodDuration" min="1" max="20" value="8">
                        <span>minutos</span>
                        <button class="btn btn-primary" id="setPeriodDuration" style="padding: 8px 15px;">
                            <i class="fas fa-check"></i> Aplicar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let localScore = 0;
        let visitorScore = 0;
        let localTimeoutsUsed = 0;
        let visitorTimeoutsUsed = 0;
        let possessionTime = 30;
        let possessionTimerInterval = null;
        let gameTimerTime = 8 * 60; // 8 minutos en segundos
        let gameTimerInterval = null;
        let isTimersRunning = false;
        let currentPeriod = 1;
        let periodDuration = 8; // minutos
        let preset30Value = 30;
        let preset20Value = 20;
        let activePreset = '30'; // '30' o '20'
        let possessionTargetTime = null; // Para guardar el tiempo objetivo de la posesión
        let gameTargetTime = null; // Para guardar el tiempo objetivo del partido
        let publicTitle = "WATERPOLO - EN DIRECTO"; // Título para la vista pública
        
        // Ventanas abiertas
        let publicViewWindow = null;
        let possession1Window = null;
        let possession2Window = null;

        // Elementos del DOM
        const localScoreEl = document.getElementById('localScore');
        const visitorScoreEl = document.getElementById('visitorScore');
        const localTimeoutsUsedEl = document.getElementById('localTimeoutsUsed');
        const visitorTimeoutsUsedEl = document.getElementById('visitorTimeoutsUsed');
        const possessionDisplayEl = document.getElementById('possessionDisplay');
        const gameTimerDisplayEl = document.getElementById('gameTimerDisplay');
        const periodDisplayEl = document.getElementById('periodDisplay');
        
        // Inicializar la aplicación
        function init() {
            // Cargar datos guardados si existen
            loadSavedData();
            
            // Configurar eventos
            setupEventListeners();
            
            // Actualizar la interfaz
            updateScores();
            updateTimeouts();
            updatePossessionDisplay();
            updateGameTimerDisplay();
            updatePeriodDisplay();
            updatePresetButtons();
            updatePresetInputs();
            updateGameTimeInputs();
            
            // Inicializar localStorage con datos válidos
            initializeLocalStorage();
        }

        // Inicializar localStorage para evitar valores null
        function initializeLocalStorage() {
            if (!localStorage.getItem('waterpolo_public_data')) {
                broadcastData();
            }
            if (!localStorage.getItem('waterpolo_timers')) {
                broadcastTimersData();
            }
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Marcador local
            document.getElementById('localPlus').addEventListener('click', () => {
                localScore++;
                updateScores();
                saveData();
                broadcastData();
            });
            
            document.getElementById('localMinus').addEventListener('click', () => {
                if (localScore > 0) localScore--;
                updateScores();
                saveData();
                broadcastData();
            });
            
            // Marcador visitante
            document.getElementById('visitorPlus').addEventListener('click', () => {
                visitorScore++;
                updateScores();
                saveData();
                broadcastData();
            });
            
            document.getElementById('visitorMinus').addEventListener('click', () => {
                if (visitorScore > 0) visitorScore--;
                updateScores();
                saveData();
                broadcastData();
            });
            
            // Tiempos muertos locales
            document.getElementById('localTimeoutAdd').addEventListener('click', () => {
                if (localTimeoutsUsed < 2) {
                    localTimeoutsUsed++;
                    updateTimeouts();
                    saveData();
                    broadcastData();
                }
            });
            
            document.getElementById('localTimeoutRemove').addEventListener('click', () => {
                if (localTimeoutsUsed > 0) {
                    localTimeoutsUsed--;
                    updateTimeouts();
                    saveData();
                    broadcastData();
                }
            });
            
            // Tiempos muertos visitantes
            document.getElementById('visitorTimeoutAdd').addEventListener('click', () => {
                if (visitorTimeoutsUsed < 2) {
                    visitorTimeoutsUsed++;
                    updateTimeouts();
                    saveData();
                    broadcastData();
                }
            });
            
            document.getElementById('visitorTimeoutRemove').addEventListener('click', () => {
                if (visitorTimeoutsUsed > 0) {
                    visitorTimeoutsUsed--;
                    updateTimeouts();
                    saveData();
                    broadcastData();
                }
            });
            
            // Controles unificados de temporizadores
            document.getElementById('startAllBtn').addEventListener('click', startAllTimers);
            document.getElementById('pauseAllBtn').addEventListener('click', pauseAllTimers);
            document.getElementById('resetAllTimersBtn').addEventListener('click', resetAllTimers);
            
            // Botones de preset (al hacer clic, reinician la posesión al valor indicado)
            document.getElementById('preset30Btn').addEventListener('click', () => {
                // Establecer el preset 30 como activo y reiniciar posesión
                activePreset = '30';
                possessionTime = preset30Value;
                updatePresetButtons();
                resetPossessionOnly(); // Solo reinicia la posesión
                updatePossessionDisplay();
                saveData();
                broadcastTimersData();
            });
            
            document.getElementById('preset20Btn').addEventListener('click', () => {
                // Establecer el preset 20 como activo y reiniciar posesión
                activePreset = '20';
                possessionTime = preset20Value;
                updatePresetButtons();
                resetPossessionOnly(); // Solo reinicia la posesión
                updatePossessionDisplay();
                saveData();
                broadcastTimersData();
            });
            
            // Botones para guardar valores editados de presets
            document.getElementById('savePreset30Btn').addEventListener('click', () => {
                const value = parseInt(document.getElementById('preset30Input').value);
                if (value >= 5 && value <= 60) {
                    preset30Value = value;
                    document.getElementById('preset30Text').textContent = value;
                    updatePresetInputs();
                    
                    // Si este preset está activo, actualizar el tiempo de posesión
                    if (activePreset === '30') {
                        possessionTime = value;
                        resetPossessionOnly(); // Solo reinicia la posesión
                        updatePossessionDisplay();
                    }
                    
                    saveData();
                    broadcastTimersData();
                } else {
                    alert('Por favor, introduce un valor entre 5 y 60 segundos.');
                    document.getElementById('preset30Input').value = preset30Value;
                }
            });
            
            document.getElementById('savePreset20Btn').addEventListener('click', () => {
                const value = parseInt(document.getElementById('preset20Input').value);
                if (value >= 5 && value <= 60) {
                    preset20Value = value;
                    document.getElementById('preset20Text').textContent = value;
                    updatePresetInputs();
                    
                    // Si este preset está activo, actualizar el tiempo de posesión
                    if (activePreset === '20') {
                        possessionTime = value;
                        resetPossessionOnly(); // Solo reinicia la posesión
                        updatePossessionDisplay();
                    }
                    
                    saveData();
                    broadcastTimersData();
                } else {
                    alert('Por favor, introduce un valor entre 5 y 60 segundos.');
                    document.getElementById('preset20Input').value = preset20Value;
                }
            });
            
            // Tiempo personalizado de posesión
            document.getElementById('setCustomTimeBtn').addEventListener('click', setCustomPossessionTime);
            document.getElementById('possessionCustomTime').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') setCustomPossessionTime();
            });
            
            // Edición exacta del tiempo de partido
            document.getElementById('setGameTimeBtn').addEventListener('click', setExactGameTime);
            document.getElementById('gameMinutesInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') setExactGameTime();
            });
            document.getElementById('gameSecondsInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') setExactGameTime();
            });
            
            // Duración del periodo
            document.getElementById('setPeriodDuration').addEventListener('click', setGameTimerDuration);
            document.getElementById('periodDuration').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') setGameTimerDuration();
            });
            
            // Periodos
            document.getElementById('prevPeriodBtn').addEventListener('click', prevPeriod);
            document.getElementById('nextPeriodBtn').addEventListener('click', nextPeriod);
            
            // Botones de control
            document.getElementById('publicViewBtn').addEventListener('click', openPublicView);
            document.getElementById('possession1WindowBtn').addEventListener('click', () => openPossessionWindow(1));
            document.getElementById('possession2WindowBtn').addEventListener('click', () => openPossessionWindow(2));
            document.getElementById('resetAllBtn').addEventListener('click', resetAll);
            
            // Guardar título de vista pública
            document.getElementById('savePublicTitleBtn').addEventListener('click', savePublicTitle);
            document.getElementById('publicTitleInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') savePublicTitle();
            });
            
            // Guardar equipos
            document.getElementById('saveLocalBtn').addEventListener('click', saveLocalTeam);
            document.getElementById('saveVisitorBtn').addEventListener('click', saveVisitorTeam);
            
            // Permitir Enter en campos de entrada
            document.getElementById('localNameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') saveLocalTeam();
            });
            
            document.getElementById('visitorNameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') saveVisitorTeam();
            });
            
            // Escuchar cambios en localStorage para sincronización
            window.addEventListener('storage', handleStorageChange);
            
            // Sincronizar periódicamente
            setInterval(() => {
                broadcastData();
                broadcastTimersData();
            }, 500);
        }

        // Guardar título de vista pública
        function savePublicTitle() {
            const title = document.getElementById('publicTitleInput').value.trim();
            if (title) {
                publicTitle = title;
                // Guardar en localStorage
                const currentData = JSON.parse(localStorage.getItem('waterpolo_public_data') || '{}');
                currentData.publicTitle = title;
                localStorage.setItem('waterpolo_public_data', JSON.stringify(currentData));
                
                // Transmitir a las ventanas abiertas
                broadcastData();
            }
        }

        // Actualizar marcadores
        function updateScores() {
            localScoreEl.textContent = localScore;
            visitorScoreEl.textContent = visitorScore;
        }

        // Actualizar tiempos muertos
        function updateTimeouts() {
            // Actualizar contadores
            localTimeoutsUsedEl.textContent = localTimeoutsUsed;
            visitorTimeoutsUsedEl.textContent = visitorTimeoutsUsed;
            
            // Actualizar cajas de tiempos muertos locales
            const localTimeout1 = document.getElementById('localTimeout1');
            const localTimeout2 = document.getElementById('localTimeout2');
            
            localTimeout1.className = 'timeout-box';
            localTimeout2.className = 'timeout-box';
            
            if (localTimeoutsUsed >= 1) localTimeout1.classList.add('timeout-used');
            if (localTimeoutsUsed >= 2) localTimeout2.classList.add('timeout-used');
            
            // Actualizar cajas de tiempos muertos visitantes
            const visitorTimeout1 = document.getElementById('visitorTimeout1');
            const visitorTimeout2 = document.getElementById('visitorTimeout2');
            
            visitorTimeout1.className = 'timeout-box';
            visitorTimeout2.className = 'timeout-box';
            
            if (visitorTimeoutsUsed >= 1) visitorTimeout1.classList.add('timeout-used');
            if (visitorTimeoutsUsed >= 2) visitorTimeout2.classList.add('timeout-used');
        }

        // Actualizar botones de preset
        function updatePresetButtons() {
            const preset30Btn = document.getElementById('preset30Btn');
            const preset20Btn = document.getElementById('preset20Btn');
            
            preset30Btn.classList.remove('active');
            preset20Btn.classList.remove('active');
            
            if (activePreset === '30') {
                preset30Btn.classList.add('active');
            } else if (activePreset === '20') {
                preset20Btn.classList.add('active');
            }
            
            // Actualizar texto de los botones
            document.getElementById('preset30Text').textContent = preset30Value;
            document.getElementById('preset20Text').textContent = preset20Value;
        }

        // Actualizar inputs de presets
        function updatePresetInputs() {
            document.getElementById('preset30Input').value = preset30Value;
            document.getElementById('preset20Input').value = preset20Value;
            document.getElementById('possessionCustomTime').value = possessionTime;
        }

        // Actualizar inputs del tiempo de partido
        function updateGameTimeInputs() {
            const minutes = Math.floor(gameTimerTime / 60);
            const seconds = gameTimerTime % 60;
            document.getElementById('gameMinutesInput').value = minutes;
            document.getElementById('gameSecondsInput').value = seconds;
            document.getElementById('periodDuration').value = periodDuration;
        }

        // Establecer tiempo exacto del partido
        function setExactGameTime() {
            const minutes = parseInt(document.getElementById('gameMinutesInput').value) || 0;
            const seconds = parseInt(document.getElementById('gameSecondsInput').value) || 0;
            
            if (minutes >= 0 && minutes <= 99 && seconds >= 0 && seconds <= 59) {
                gameTimerTime = minutes * 60 + seconds;
                
                // Si el temporizador está corriendo, actualizar el tiempo objetivo
                if (isTimersRunning && gameTargetTime) {
                    const now = Date.now();
                    const elapsed = gameTargetTime - now;
                    if (elapsed > 0) {
                        gameTargetTime = now + (gameTimerTime * 1000);
                    }
                }
                
                updateGameTimerDisplay();
                saveData();
                broadcastTimersData();
            } else {
                alert('Por favor, introduce valores válidos: minutos (0-99) y segundos (0-59).');
                updateGameTimeInputs();
            }
        }

        // Reiniciar solo la posesión (no el cronómetro general)
        function resetPossessionOnly() {
            // Solo reiniciamos el temporizador de posesión si está corriendo
            if (isTimersRunning) {
                // Limpiar intervalo de posesión
                clearInterval(possessionTimerInterval);
                
                // Restablecer display
                possessionDisplayEl.textContent = possessionTime;
                possessionDisplayEl.style.color = '#4ecdc4';
                
                // Establecer nuevo tiempo objetivo
                const now = Date.now();
                possessionTargetTime = now + (possessionTime * 1000);
                
                // Volver a iniciar el temporizador de posesión con el nuevo tiempo
                restartPossessionTimer();
            } else {
                // Si no está corriendo, solo actualizar el display
                possessionDisplayEl.textContent = possessionTime;
                possessionDisplayEl.style.color = '#4ecdc4';
            }
            
            // Sincronizar cambio
            broadcastTimersData();
        }

        // Reiniciar el temporizador de posesión (usado internamente)
        function restartPossessionTimer() {
            clearInterval(possessionTimerInterval);
            
            possessionTimerInterval = setInterval(() => {
                const now = Date.now();
                const remaining = Math.max(0, possessionTargetTime - now);
                
                const seconds = Math.ceil(remaining / 1000);
                possessionDisplayEl.textContent = seconds;
                
                // Cambiar color cuando queden 5 segundos o menos
                if (seconds <= 5) {
                    possessionDisplayEl.style.color = '#ff6b6b';
                } else {
                    possessionDisplayEl.style.color = '#4ecdc4';
                }
                
                // Cuando llegue a cero, PAUSAR AMBOS TEMPORIZADORES
                if (remaining <= 0) {
                    // Pausar ambos temporizadores automáticamente
                    pauseAllTimers();
                    
                    // Asegurarse de que muestra 0
                    possessionDisplayEl.textContent = 0;
                    possessionDisplayEl.style.color = '#ff6b6b';
                    
                    // Reproducir sonido de alarma
                    playBeepSound();
                    
                    // Mostrar alerta visual
                    flashPossessionDisplay();
                }
            }, 100);
        }

        // Efecto visual cuando la posesión llega a 0
        function flashPossessionDisplay() {
            let flashCount = 0;
            const maxFlashes = 6;
            const flashInterval = setInterval(() => {
                if (flashCount >= maxFlashes * 2) {
                    clearInterval(flashInterval);
                    possessionDisplayEl.style.backgroundColor = '';
                    return;
                }
                
                if (flashCount % 2 === 0) {
                    possessionDisplayEl.style.backgroundColor = 'rgba(255, 107, 107, 0.3)';
                } else {
                    possessionDisplayEl.style.backgroundColor = '';
                }
                
                flashCount++;
            }, 300);
        }

        // Controles unificados de temporizadores - NO REINICIA LA POSESIÓN AL INICIAR
        function startAllTimers() {
            if (isTimersRunning) return;
            
            isTimersRunning = true;
            updateTimerButtonsState();
            
            const now = Date.now();
            
            // Iniciar temporizador de partido - CONTINÚA DESDE DONDE IBA
            gameTargetTime = now + (gameTimerTime * 1000);
            
            clearInterval(gameTimerInterval);
            gameTimerInterval = setInterval(() => {
                const currentNow = Date.now();
                const remaining = Math.max(0, gameTargetTime - currentNow);
                
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                
                gameTimerDisplayEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Cuando llegue a cero, solo detener este temporizador
                if (remaining <= 0) {
                    clearInterval(gameTimerInterval);
                }
            }, 100);
            
            // Iniciar temporizador de posesión - CONTINÚA DESDE DONDE IBA
            // Si no hay tiempo objetivo establecido, establecer uno nuevo
            if (!possessionTargetTime || possessionTargetTime <= now) {
                possessionTargetTime = now + (possessionTime * 1000);
            }
            
            // Verificar el tiempo restante actual para la posesión
            const initialPossessionRemaining = Math.max(0, possessionTargetTime - now);
            const initialSeconds = Math.ceil(initialPossessionRemaining / 1000);
            
            // Si ya está en 0, no iniciar la posesión
            if (initialSeconds <= 0) {
                possessionDisplayEl.textContent = 0;
                possessionDisplayEl.style.color = '#ff6b6b';
                // No iniciar el intervalo de posesión, ambos estarán pausados
            } else {
                // Iniciar el temporizador de posesión normalmente
                restartPossessionTimer();
                
                // Actualizar display inicial
                possessionDisplayEl.textContent = initialSeconds;
                if (initialSeconds <= 5) {
                    possessionDisplayEl.style.color = '#ff6b6b';
                } else {
                    possessionDisplayEl.style.color = '#4ecdc4';
                }
            }
            
            // Sincronizar inicio
            broadcastTimersData();
        }

        function pauseAllTimers() {
            if (!isTimersRunning) return;
            
            clearInterval(gameTimerInterval);
            clearInterval(possessionTimerInterval);
            
            // Guardar tiempo restante del partido
            const currentGameTime = gameTimerDisplayEl.textContent;
            const [minutes, seconds] = currentGameTime.split(':').map(Number);
            gameTimerTime = minutes * 60 + seconds;
            
            // Guardar tiempo restante de la posesión
            const currentPossessionTime = parseInt(possessionDisplayEl.textContent);
            if (currentPossessionTime > 0) {
                // Solo actualizar si no está en 0
                const now = Date.now();
                possessionTargetTime = now + (currentPossessionTime * 1000);
            }
            
            isTimersRunning = false;
            updateTimerButtonsState();
            
            // Sincronizar pausa
            broadcastTimersData();
        }

        function resetAllTimers() {
            clearInterval(gameTimerInterval);
            clearInterval(possessionTimerInterval);
            
            isTimersRunning = false;
            gameTimerTime = periodDuration * 60;
            possessionTargetTime = null;
            possessionDisplayEl.style.color = '#4ecdc4';
            possessionDisplayEl.style.backgroundColor = '';
            
            updateGameTimerDisplay();
            updatePossessionDisplay();
            updateTimerButtonsState();
            updateGameTimeInputs();
            
            // Sincronizar reinicio
            broadcastTimersData();
        }

        // Actualizar estado de botones de temporizador
        function updateTimerButtonsState() {
            const startBtn = document.getElementById('startAllBtn');
            const pauseBtn = document.getElementById('pauseAllBtn');
            const resetBtn = document.getElementById('resetAllTimersBtn');
            
            if (isTimersRunning) {
                startBtn.disabled = true;
                pauseBtn.disabled = false;
                resetBtn.disabled = false;
            } else {
                startBtn.disabled = false;
                pauseBtn.disabled = true;
                resetBtn.disabled = false;
            }
        }

        function setCustomPossessionTime() {
            const customTime = parseInt(document.getElementById('possessionCustomTime').value);
            if (customTime >= 5 && customTime <= 60) {
                possessionTime = customTime;
                updatePresetInputs();
                
                // No marcamos ningún preset como activo cuando usamos tiempo personalizado
                activePreset = 'custom';
                updatePresetButtons();
                
                resetPossessionOnly(); // Solo reinicia la posesión
                updatePossessionDisplay();
                saveData();
                broadcastTimersData();
            } else {
                alert('Por favor, introduce un valor entre 5 y 60 segundos.');
                document.getElementById('possessionCustomTime').value = possessionTime;
            }
        }

        function updatePossessionDisplay() {
            // Solo actualizar si no está corriendo o si estamos en modo pausa
            if (!isTimersRunning) {
                possessionDisplayEl.textContent = possessionTime;
            }
        }

        function setGameTimerDuration() {
            const duration = parseInt(document.getElementById('periodDuration').value);
            if (duration >= 1 && duration <= 20) {
                periodDuration = duration;
                if (!isTimersRunning) {
                    gameTimerTime = duration * 60;
                    updateGameTimerDisplay();
                    updateGameTimeInputs();
                }
                saveData();
                broadcastTimersData();
            } else {
                alert('Por favor, introduce un valor entre 1 y 20 minutos.');
                document.getElementById('periodDuration').value = periodDuration;
            }
        }

        function updateGameTimerDisplay() {
            const minutes = Math.floor(gameTimerTime / 60);
            const seconds = gameTimerTime % 60;
            gameTimerDisplayEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Control de periodos
        function prevPeriod() {
            if (currentPeriod > 1) {
                currentPeriod--;
                updatePeriodDisplay();
                saveData();
                broadcastData();
            }
        }

        function nextPeriod() {
            if (currentPeriod < 4) {
                currentPeriod++;
                updatePeriodDisplay();
                saveData();
                broadcastData();
            }
        }

        function updatePeriodDisplay() {
            periodDisplayEl.textContent = `PERIODO ${currentPeriod}`;
        }

        // Abrir vista pública (MEJORADA con título editable y diseño optimizado)
        function openPublicView() {
            if (publicViewWindow && !publicViewWindow.closed) {
                publicViewWindow.focus();
                return;
            }
            
            publicViewWindow = window.open('', 'PublicViewWindow', 'width=900,height=700,left=100,top=100');
            
            if (publicViewWindow) {
                const publicViewHTML = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Marcador de Waterpolo - Vista Pública</title>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                        <style>
                            * {
                                margin: 0;
                                padding: 0;
                                box-sizing: border-box;
                                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            }
                            
                            body {
                                background: linear-gradient(135deg, #0a2463 0%, #1a3d7a 100%);
                                color: white;
                                height: 100vh;
                                display: flex;
                                flex-direction: column;
                                padding: 15px;
                                overflow: hidden;
                            }
                            
                            .header {
                                text-align: center;
                                padding: 15px;
                                background-color: rgba(0, 30, 80, 0.8);
                                border-radius: 15px;
                                margin-bottom: 10px;
                                border: 2px solid rgba(255, 255, 255, 0.1);
                                min-height: 80px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            }
                            
                            .title {
                                font-size: 2.3rem;
                                color: #ffd166;
                                font-weight: 700;
                                text-align: center;
                                width: 100%;
                            }
                            
                            .scoreboard {
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                margin-bottom: 15px;
                                flex-grow: 1;
                                min-height: 400px;
                            }
                            
                            .team {
                                text-align: center;
                                flex: 1;
                                padding: 15px;
                                height: 100%;
                                display: flex;
                                flex-direction: column;
                                justify-content: center;
                            }
                            
                            .team-logo {
                                width: 140px;
                                height: 140px;
                                margin: 0 auto 15px;
                                background-color: rgba(255, 255, 255, 0.2);
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 3.8rem;
                                color: white;
                                border: 5px solid rgba(255, 255, 255, 0.3);
                                overflow: hidden;
                            }
                            
                            .logo-img {
                                width: 100%;
                                height: 100%;
                                object-fit: cover;
                            }
                            
                            .team-name {
                                font-size: 2.2rem;
                                font-weight: bold;
                                margin-bottom: 15px;
                                color: white;
                                height: 60px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            }
                            
                            .team-score {
                                font-size: 5.5rem;
                                font-weight: 800;
                                color: #ffd166;
                                text-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
                                height: 100px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            }
                            
                            .timeouts {
                                display: flex;
                                justify-content: center;
                                gap: 15px;
                                margin-top: 10px;
                            }
                            
                            .timeout-dot {
                                width: 38px;
                                height: 38px;
                                border-radius: 50%;
                                background-color: rgba(255, 255, 255, 0.2);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-weight: bold;
                                font-size: 1.1rem;
                            }
                            
                            .timeout-used {
                                background-color: #ff6b6b;
                            }
                            
                            .center-info {
                                text-align: center;
                                padding: 0 30px;
                                flex: 1.3;
                                display: flex;
                                flex-direction: column;
                                justify-content: center;
                            }
                            
                            .timers-container {
                                display: flex;
                                justify-content: space-around;
                                margin-bottom: 20px;
                                gap: 30px;
                            }
                            
                            .timer-box {
                                text-align: center;
                                flex: 1;
                            }
                            
                            .timer-label {
                                font-size: 1.4rem;
                                margin-bottom: 8px;
                                color: #ffd166;
                            }
                            
                            .game-timer {
                                font-size: 3.8rem;
                                font-weight: 800;
                                color: #4ecdc4;
                                font-family: 'Courier New', monospace;
                            }
                            
                            .possession-timer {
                                font-size: 3.8rem;
                                font-weight: 800;
                                color: #4ecdc4;
                                font-family: 'Courier New', monospace;
                            }
                            
                            .period {
                                font-size: 2rem;
                                font-weight: bold;
                                color: #ffd166;
                                background-color: rgba(255, 255, 255, 0.1);
                                padding: 10px 30px;
                                border-radius: 50px;
                                display: inline-block;
                                margin-top: 15px;
                            }
                            
                            .timer-status {
                                font-size: 1.2rem;
                                margin-top: 8px;
                                padding: 5px 15px;
                                border-radius: 20px;
                                display: inline-block;
                            }
                            
                            .status-running {
                                background-color: rgba(78, 205, 196, 0.3);
                                color: #4ecdc4;
                            }
                            
                            .status-paused {
                                background-color: rgba(255, 107, 107, 0.3);
                                color: #ff6b6b;
                            }
                            
                            .footer {
                                text-align: center;
                                padding: 10px;
                                margin-top: 10px;
                                font-size: 0.9rem;
                                color: rgba(255, 255, 255, 0.7);
                                border-top: 1px solid rgba(255, 255, 255, 0.1);
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1 class="title" id="publicTitle">${publicTitle}</h1>
                        </div>
                        
                        <div class="scoreboard">
                            <div class="team" id="publicLocalTeam">
                                <div class="team-logo" id="publicLocalLogo">
                                    <i class="fas fa-swimmer"></i>
                                </div>
                                <div class="team-name" id="publicLocalName">LOCAL</div>
                                <div class="team-score" id="publicLocalScore">0</div>
                                <div class="timeouts" id="publicLocalTimeouts">
                                    <div class="timeout-dot">1</div>
                                    <div class="timeout-dot">2</div>
                                </div>
                            </div>
                            
                            <div class="center-info">
                                <div class="timers-container">
                                    <div class="timer-box">
                                        <div class="timer-label">TIEMPO DE PARTIDO</div>
                                        <div class="game-timer" id="publicGameTimer">08:00</div>
                                        <div class="timer-status status-paused" id="gameTimerStatus">PAUSADO</div>
                                    </div>
                                    
                                    <div class="timer-box">
                                        <div class="timer-label">TIEMPO DE POSESIÓN</div>
                                        <div class="possession-timer" id="publicPossessionTimer">30</div>
                                        <div class="timer-status status-paused" id="possessionTimerStatus">PAUSADO</div>
                                    </div>
                                </div>
                                
                                <div class="period" id="publicPeriod">PERIODO 1</div>
                            </div>
                            
                            <div class="team" id="publicVisitorTeam">
                                <div class="team-logo" id="publicVisitorLogo">
                                    <i class="fas fa-water"></i>
                                </div>
                                <div class="team-name" id="publicVisitorName">VISITANTE</div>
                                <div class="team-score" id="publicVisitorScore">0</div>
                                <div class="timeouts" id="publicVisitorTimeouts">
                                    <div class="timeout-dot">1</div>
                                    <div class="timeout-dot">2</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="footer">
                            Marcador de Waterpolo - Actualizado en tiempo real
                        </div>
                        
                        <script>
                            // Función para actualizar la vista pública con datos
                            function updatePublicView(data) {
                                // Verificar que los datos no sean null
                                if (!data) return;
                                
                                if (data.localScore !== undefined && data.localScore !== null) {
                                    document.getElementById('publicLocalScore').textContent = data.localScore;
                                }
                                
                                if (data.visitorScore !== undefined && data.visitorScore !== null) {
                                    document.getElementById('publicVisitorScore').textContent = data.visitorScore;
                                }
                                
                                if (data.localName !== undefined && data.localName !== null) {
                                    document.getElementById('publicLocalName').textContent = data.localName;
                                }
                                
                                if (data.visitorName !== undefined && data.visitorName !== null) {
                                    document.getElementById('publicVisitorName').textContent = data.visitorName;
                                }
                                
                                if (data.localLogo !== undefined && data.localLogo !== null) {
                                    document.getElementById('publicLocalLogo').innerHTML = data.localLogo;
                                }
                                
                                if (data.visitorLogo !== undefined && data.visitorLogo !== null) {
                                    document.getElementById('publicVisitorLogo').innerHTML = data.visitorLogo;
                                }
                                
                                if (data.localTimeoutsUsed !== undefined && data.localTimeoutsUsed !== null) {
                                    const timeouts = document.querySelectorAll('#publicLocalTimeouts .timeout-dot');
                                    timeouts.forEach((dot, index) => {
                                        dot.className = 'timeout-dot';
                                        if (index < data.localTimeoutsUsed) {
                                            dot.classList.add('timeout-used');
                                        }
                                    });
                                }
                                
                                if (data.visitorTimeoutsUsed !== undefined && data.visitorTimeoutsUsed !== null) {
                                    const timeouts = document.querySelectorAll('#publicVisitorTimeouts .timeout-dot');
                                    timeouts.forEach((dot, index) => {
                                        dot.className = 'timeout-dot';
                                        if (index < data.visitorTimeoutsUsed) {
                                            dot.classList.add('timeout-used');
                                        }
                                    });
                                }
                                
                                if (data.periodDisplay !== undefined && data.periodDisplay !== null) {
                                    document.getElementById('publicPeriod').textContent = data.periodDisplay;
                                }
                                
                                // Actualizar título si está presente en los datos
                                if (data.publicTitle !== undefined && data.publicTitle !== null) {
                                    document.getElementById('publicTitle').textContent = data.publicTitle;
                                }
                            }
                            
                            // Función para actualizar temporizadores
                            function updateTimers(timersData) {
                                if (!timersData) return;
                                
                                if (timersData.gameTimerDisplay !== undefined && timersData.gameTimerDisplay !== null) {
                                    document.getElementById('publicGameTimer').textContent = timersData.gameTimerDisplay;
                                }
                                
                                if (timersData.possessionDisplay !== undefined && timersData.possessionDisplay !== null) {
                                    const possessionValue = parseInt(timersData.possessionDisplay);
                                    if (!isNaN(possessionValue)) {
                                        document.getElementById('publicPossessionTimer').textContent = timersData.possessionDisplay;
                                        // Cambiar color cuando queden 5 segundos o menos
                                        if (possessionValue <= 5) {
                                            document.getElementById('publicPossessionTimer').style.color = '#ff6b6b';
                                        } else {
                                            document.getElementById('publicPossessionTimer').style.color = '#4ecdc4';
                                        }
                                    }
                                }
                                
                                if (timersData.isRunning !== undefined && timersData.isRunning !== null) {
                                    const status = timersData.isRunning ? 'EN CURSO' : 'PAUSADO';
                                    const statusClass = timersData.isRunning ? 'status-running' : 'status-paused';
                                    
                                    document.getElementById('gameTimerStatus').textContent = status;
                                    document.getElementById('gameTimerStatus').className = 'timer-status ' + statusClass;
                                    
                                    document.getElementById('possessionTimerStatus').textContent = status;
                                    document.getElementById('possessionTimerStatus').className = 'timer-status ' + statusClass;
                                }
                            }
                            
                            // Escuchar mensajes del panel de control
                            window.addEventListener('storage', function(e) {
                                if (e.key === 'waterpolo_public_data' && e.newValue) {
                                    try {
                                        const data = JSON.parse(e.newValue);
                                        updatePublicView(data);
                                    } catch(error) {
                                        console.log('Error al parsear datos:', error);
                                    }
                                }
                                
                                if (e.key === 'waterpolo_timers' && e.newValue) {
                                    try {
                                        const data = JSON.parse(e.newValue);
                                        updateTimers(data);
                                    } catch(error) {
                                        console.log('Error al parsear datos de temporizadores:', error);
                                    }
                                }
                            });
                            
                            // Cargar datos iniciales
                            const initialData = localStorage.getItem('waterpolo_public_data');
                            const initialTimersData = localStorage.getItem('waterpolo_timers');
                            
                            if (initialData) {
                                try {
                                    const data = JSON.parse(initialData);
                                    updatePublicView(data);
                                } catch(error) {
                                    console.log('Error al cargar datos iniciales:', error);
                                }
                            }
                            
                            if (initialTimersData) {
                                try {
                                    const data = JSON.parse(initialTimersData);
                                    updateTimers(data);
                                } catch(error) {
                                    console.log('Error al cargar datos de temporizadores:', error);
                                }
                            }
                        <\/script>
                    </body>
                    </html>
                `;
                
                publicViewWindow.document.write(publicViewHTML);
                publicViewWindow.document.close();
                
                // Enviar datos iniciales
                setTimeout(() => {
                    broadcastData();
                    broadcastTimersData();
                }, 500);
            } else {
                alert('Por favor, permite ventanas emergentes para esta función.');
            }
        }

        // Abrir ventana de temporizador de posesión
        function openPossessionWindow(num) {
            let targetWindow = num === 1 ? possession1Window : possession2Window;
            
            if (targetWindow && !targetWindow.closed) {
                targetWindow.focus();
                return;
            }
            
            const windowWidth = 500;
            const windowHeight = 500;
            const leftPosition = 100 + (num - 1) * (windowWidth + 20);
            
            targetWindow = window.open('', `PossessionWindow${num}`, `width=${windowWidth},height=${windowHeight},left=${leftPosition},top=100`);
            
            if (targetWindow) {
                if (num === 1) possession1Window = targetWindow;
                else possession2Window = targetWindow;
                
                const possessionWindowHTML = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Temporizador de Posesión ${num}</title>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                        <style>
                            * {
                                margin: 0;
                                padding: 0;
                                box-sizing: border-box;
                                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            }
                            
                            body {
                                background: linear-gradient(135deg, #0a2463 0%, #1a3d7a 100%);
                                color: white;
                                height: 100vh;
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                justify-content: center;
                                padding: 20px;
                                text-align: center;
                            }
                            
                            .title {
                                font-size: 2.5rem;
                                margin-bottom: 20px;
                                color: #ffd166;
                            }
                            
                            .timer-container {
                                margin: 30px 0;
                            }
                            
                            .timer {
                                font-size: 8rem;
                                font-weight: 800;
                                color: #4ecdc4;
                                text-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
                                font-family: 'Courier New', monospace;
                                min-height: 120px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            }
                            
                            .status {
                                font-size: 1.5rem;
                                margin-top: 20px;
                                color: rgba(255, 255, 255, 0.9);
                                padding: 10px 30px;
                                background-color: rgba(0, 0, 0, 0.3);
                                border-radius: 50px;
                                display: inline-block;
                            }
                            
                            .status-running {
                                background-color: rgba(78, 205, 196, 0.3);
                                color: #4ecdc4;
                            }
                            
                            .status-paused {
                                background-color: rgba(255, 107, 107, 0.3);
                                color: #ff6b6b;
                            }
                            
                            .game-timer-container {
                                margin-top: 30px;
                                padding: 20px;
                                background-color: rgba(255, 255, 255, 0.1);
                                border-radius: 15px;
                                width: 100%;
                                max-width: 400px;
                            }
                            
                            .game-timer-title {
                                font-size: 1.3rem;
                                margin-bottom: 10px;
                                color: #ffd166;
                            }
                            
                            .game-timer {
                                font-size: 2.5rem;
                                font-weight: 800;
                                color: #ffd166;
                                font-family: 'Courier New', monospace;
                            }
                            
                            .footer {
                                position: absolute;
                                bottom: 15px;
                                font-size: 0.9rem;
                                color: rgba(255, 255, 255, 0.6);
                                text-align: center;
                                width: 100%;
                            }
                        </style>
                    </head>
                    <body>
                        <div class="title">TIEMPO DE POSESIÓN ${num}</div>
                        
                        <div class="timer-container">
                            <div class="timer" id="possessionTimer">${possessionTime}</div>
                            <div class="status status-paused" id="possessionStatus">PAUSADO</div>
                        </div>
                        
                        <div class="game-timer-container">
                            <div class="game-timer-title">CRONÓMETRO GENERAL</div>
                            <div class="game-timer" id="gameTimer">08:00</div>
                            <div class="status status-paused" id="gameTimerStatus">PAUSADO</div>
                        </div>
                        
                        <div class="footer">
                            Sincronizado con el panel de control - Ventana ${num}
                        </div>
                        
                        <script>
                            // Función para actualizar los temporizadores
                            function updateTimers(timersData) {
                                if (!timersData) return;
                                
                                if (timersData.gameTimerDisplay !== undefined && timersData.gameTimerDisplay !== null) {
                                    document.getElementById('gameTimer').textContent = timersData.gameTimerDisplay;
                                }
                                
                                if (timersData.possessionDisplay !== undefined && timersData.possessionDisplay !== null) {
                                    const possessionValue = parseInt(timersData.possessionDisplay);
                                    if (!isNaN(possessionValue)) {
                                        document.getElementById('possessionTimer').textContent = timersData.possessionDisplay;
                                        // Cambiar color cuando queden 5 segundos o menos
                                        if (possessionValue <= 5) {
                                            document.getElementById('possessionTimer').style.color = '#ff6b6b';
                                        } else {
                                            document.getElementById('possessionTimer').style.color = '#4ecdc4';
                                        }
                                    }
                                }
                                
                                if (timersData.isRunning !== undefined && timersData.isRunning !== null) {
                                    const status = timersData.isRunning ? 'EN CURSO' : 'PAUSADO';
                                    const statusClass = timersData.isRunning ? 'status-running' : 'status-paused';
                                    
                                    document.getElementById('possessionStatus').textContent = status;
                                    document.getElementById('possessionStatus').className = 'status ' + statusClass;
                                    
                                    document.getElementById('gameTimerStatus').textContent = status;
                                    document.getElementById('gameTimerStatus').className = 'status ' + statusClass;
                                }
                            }
                            
                            // Escuchar mensajes del panel de control
                            window.addEventListener('storage', function(e) {
                                if (e.key === 'waterpolo_timers' && e.newValue) {
                                    try {
                                        const data = JSON.parse(e.newValue);
                                        updateTimers(data);
                                    } catch(error) {
                                        console.log('Error al parsear datos del temporizador:', error);
                                    }
                                }
                            });
                            
                            // Cargar estado inicial
                            const initialTimersData = localStorage.getItem('waterpolo_timers');
                            
                            if (initialTimersData) {
                                try {
                                    const data = JSON.parse(initialTimersData);
                                    updateTimers(data);
                                } catch(error) {
                                    console.log('Error al cargar datos iniciales:', error);
                                }
                            }
                        <\/script>
                    </body>
                    </html>
                `;
                
                targetWindow.document.write(possessionWindowHTML);
                targetWindow.document.close();
                
                // Enviar datos iniciales
                setTimeout(() => {
                    broadcastTimersData();
                }, 500);
            } else {
                alert('Por favor, permite ventanas emergentes para esta función.');
            }
        }

        // Transmitir datos a las ventanas
        function broadcastData() {
            const title = document.getElementById('publicTitleInput').value.trim() || "WATERPOLO - EN DIRECTO";
            publicTitle = title;
            
            const data = {
                localScore,
                visitorScore,
                localName: document.getElementById('localName').textContent,
                visitorName: document.getElementById('visitorName').textContent,
                localLogo: document.getElementById('localLogo').innerHTML,
                visitorLogo: document.getElementById('visitorLogo').innerHTML,
                localTimeoutsUsed,
                visitorTimeoutsUsed,
                periodDisplay: periodDisplayEl.textContent,
                publicTitle: title // Añadir el título personalizado
            };
            
            try {
                localStorage.setItem('waterpolo_public_data', JSON.stringify(data));
            } catch(e) {
                console.log('Error al guardar en localStorage:', e);
            }
        }

        // Transmitir datos de temporizadores
        function broadcastTimersData() {
            const data = {
                gameTimerDisplay: gameTimerDisplayEl.textContent,
                possessionDisplay: possessionDisplayEl.textContent,
                isRunning: isTimersRunning
            };
            
            try {
                localStorage.setItem('waterpolo_timers', JSON.stringify(data));
            } catch(e) {
                console.log('Error al guardar temporizadores en localStorage:', e);
            }
        }

        // Manejar cambios en localStorage
        function handleStorageChange(e) {
            // Solo manejar cambios si son de otras pestañas
        }

        // Reiniciar todo
        function resetAll() {
            if (confirm('¿Estás seguro de que quieres reiniciar todo? Se perderán los datos del partido actual.')) {
                localScore = 0;
                visitorScore = 0;
                localTimeoutsUsed = 0;
                visitorTimeoutsUsed = 0;
                
                // Restablecer presets a valores por defecto
                preset30Value = 30;
                preset20Value = 20;
                possessionTime = 30;
                activePreset = '30';
                
                // Restablecer título
                document.getElementById('publicTitleInput').value = "";
                publicTitle = "WATERPOLO - EN DIRECTO";
                
                resetAllTimers();
                currentPeriod = 1;
                updatePeriodDisplay();
                updatePresetButtons();
                updatePresetInputs();
                
                updateScores();
                updateTimeouts();
                saveData();
                broadcastData();
                broadcastTimersData();
            }
        }

        // Guardar equipo local
        function saveLocalTeam() {
            const name = document.getElementById('localNameInput').value.trim();
            const logoUrl = document.getElementById('localLogoInput').value.trim();
            
            if (name) {
                document.getElementById('localName').textContent = name;
            }
            
            if (logoUrl) {
                document.getElementById('localLogo').innerHTML = `<img src="${logoUrl}" alt="${name}" class="logo-img">`;
            } else {
                document.getElementById('localLogo').innerHTML = '<i class="fas fa-swimmer logo-placeholder"></i>';
            }
            
            saveData();
            broadcastData();
        }

        // Guardar equipo visitante
        function saveVisitorTeam() {
            const name = document.getElementById('visitorNameInput').value.trim();
            const logoUrl = document.getElementById('visitorLogoInput').value.trim();
            
            if (name) {
                document.getElementById('visitorName').textContent = name;
            }
            
            if (logoUrl) {
                document.getElementById('visitorLogo').innerHTML = `<img src="${logoUrl}" alt="${name}" class="logo-img">`;
            } else {
                document.getElementById('visitorLogo').innerHTML = '<i class="fas fa-water logo-placeholder"></i>';
            }
            
            saveData();
            broadcastData();
        }

        // Reproducir sonido de beep
        function playBeepSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch(e) {
                console.log("No se pudo reproducir sonido");
            }
        }

        // Guardar datos en localStorage
        function saveData() {
            const data = {
                localScore,
                visitorScore,
                localTimeoutsUsed,
                visitorTimeoutsUsed,
                possessionTime,
                gameTimerTime,
                isTimersRunning,
                currentPeriod,
                periodDuration,
                preset30Value,
                preset20Value,
                activePreset,
                localName: document.getElementById('localName').textContent,
                visitorName: document.getElementById('visitorName').textContent,
                localLogo: document.getElementById('localLogo').innerHTML,
                visitorLogo: document.getElementById('visitorLogo').innerHTML,
                localNameInput: document.getElementById('localNameInput').value,
                visitorNameInput: document.getElementById('visitorNameInput').value,
                localLogoInput: document.getElementById('localLogoInput').value,
                visitorLogoInput: document.getElementById('visitorLogoInput').value,
                publicTitleInput: document.getElementById('publicTitleInput').value
            };
            
            try {
                localStorage.setItem('waterpolo_control_panel', JSON.stringify(data));
            } catch(e) {
                console.log('Error al guardar datos en localStorage:', e);
            }
        }

        // Cargar datos guardados
        function loadSavedData() {
            const savedData = localStorage.getItem('waterpolo_control_panel');
            
            if (savedData) {
                try {
                    const data = JSON.parse(savedData);
                    
                    localScore = data.localScore || 0;
                    visitorScore = data.visitorScore || 0;
                    localTimeoutsUsed = data.localTimeoutsUsed || 0;
                    visitorTimeoutsUsed = data.visitorTimeoutsUsed || 0;
                    possessionTime = data.possessionTime || 30;
                    gameTimerTime = data.gameTimerTime || 8 * 60;
                    isTimersRunning = data.isTimersRunning || false;
                    currentPeriod = data.currentPeriod || 1;
                    periodDuration = data.periodDuration || 8;
                    preset30Value = data.preset30Value || 30;
                    preset20Value = data.preset20Value || 20;
                    activePreset = data.activePreset || '30';
                    
                    if (data.localName) {
                        document.getElementById('localName').textContent = data.localName;
                    }
                    
                    if (data.visitorName) {
                        document.getElementById('visitorName').textContent = data.visitorName;
                    }
                    
                    if (data.localLogo) {
                        document.getElementById('localLogo').innerHTML = data.localLogo;
                    }
                    
                    if (data.visitorLogo) {
                        document.getElementById('visitorLogo').innerHTML = data.visitorLogo;
                    }
                    
                    if (data.localNameInput) {
                        document.getElementById('localNameInput').value = data.localNameInput;
                    }
                    
                    if (data.visitorNameInput) {
                        document.getElementById('visitorNameInput').value = data.visitorNameInput;
                    }
                    
                    if (data.localLogoInput) {
                        document.getElementById('localLogoInput').value = data.localLogoInput;
                    }
                    
                    if (data.visitorLogoInput) {
                        document.getElementById('visitorLogoInput').value = data.visitorLogoInput;
                    }
                    
                    if (data.publicTitleInput) {
                        document.getElementById('publicTitleInput').value = data.publicTitleInput;
                        publicTitle = data.publicTitleInput || "WATERPOLO - EN DIRECTO";
                    }
                    
                    // Actualizar presets
                    updatePresetButtons();
                    updatePresetInputs();
                    updateGameTimeInputs();
                    
                    // Actualizar estado de botones de temporizador
                    updateTimerButtonsState();
                    
                    // Si los temporizadores estaban corriendo, actualizar display
                    updateGameTimerDisplay();
                    updatePossessionDisplay();
                    
                } catch(e) {
                    console.log('Error al cargar datos guardados:', e);
                }
            }
        }

        // Inicializar la aplicación cuando se cargue la página
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>