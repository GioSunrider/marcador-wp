<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Control - Marcador de Waterpolo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #0a2463 0%, #1a3d7a 100%);
            color: white;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background-color: rgba(0, 30, 80, 0.8);
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }
        
        h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            color: #fff;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: #3e92cc;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2a7db5;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .btn-secondary {
            background-color: #ff6b6b;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #ff5252;
            transform: translateY(-3px);
        }
        
        .btn-success {
            background-color: #4ecdc4;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #3db8af;
            transform: translateY(-3px);
        }
        
        .btn-warning {
            background-color: #ffd166;
            color: #333;
        }
        
        .btn-warning:hover {
            background-color: #ffc145;
            transform: translateY(-3px);
        }
        
        .main-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .panel {
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .panel-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #ffd166;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 10px;
        }
        
        .team-header {
            margin-bottom: 25px;
        }
        
        .team-name {
            font-size: 2rem;
            margin-bottom: 15px;
            font-weight: 700;
            color: #fff;
        }
        
        .team-logo {
            width: 120px;
            height: 120px;
            margin: 0 auto 20px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            color: white;
            border: 5px solid rgba(255, 255, 255, 0.3);
            overflow: hidden;
        }
        
        .logo-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .logo-placeholder {
            font-size: 2.5rem;
        }
        
        .score-section {
            margin-bottom: 25px;
        }
        
        .score {
            font-size: 5rem;
            font-weight: 800;
            color: #ffd166;
            text-shadow: 0 3px 10px rgba(0, 0, 0, 0.4);
            margin: 10px 0;
        }
        
        .score-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 15px;
        }
        
        .score-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: none;
            font-size: 1.8rem;
            font-weight: bold;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .score-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        .timeouts-section {
            margin-top: 25px;
        }
        
        .timeouts-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #ffd166;
        }
        
        .timeouts-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .timeout-box {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background-color: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .timeout-used {
            background-color: #ff6b6b;
        }
        
        .timeout-btn {
            padding: 10px 20px;
            border-radius: 50px;
            border: none;
            background-color: #ff6b6b;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .timeout-btn:hover {
            background-color: #ff5252;
            transform: translateY(-3px);
        }
        
        .timer-display {
            font-size: 5rem;
            font-weight: 800;
            color: #4ecdc4;
            margin: 20px 0;
            text-shadow: 0 3px 10px rgba(0, 0, 0, 0.4);
            font-family: 'Courier New', monospace;
        }
        
        .timer-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .timer-presets {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        
        .timer-preset-btn {
            padding: 10px 20px;
            border-radius: 50px;
            border: 2px solid #4ecdc4;
            background-color: transparent;
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .timer-preset-btn:hover {
            background-color: #4ecdc4;
        }
        
        .timer-preset-btn.active {
            background-color: #4ecdc4;
        }
        
        .edit-input {
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #3e92cc;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1rem;
            width: 100%;
            max-width: 300px;
            margin-bottom: 10px;
        }
        
        .edit-time-input {
            width: 80px;
            padding: 8px;
            border-radius: 8px;
            border: 2px solid #3e92cc;
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1.2rem;
            text-align: center;
        }
        
        .edit-team-form {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            align-items: center;
        }
        
        .edit-timeout-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
        }
        
        .edit-timeout-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .edit-timeout-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        .general-timer {
            grid-column: span 2;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
        }
        
        .general-timer-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        
        .period-control {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
            justify-content: center;
        }
        
        .period-display {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ffd166;
            background-color: rgba(255, 255, 255, 0.1);
            padding: 8px 20px;
            border-radius: 50px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .general-timer {
                grid-column: span 1;
            }
            
            h1 {
                font-size: 2.2rem;
            }
            
            .timer-display {
                font-size: 4rem;
            }
            
            .score {
                font-size: 4rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-water"></i> Panel de Control - Marcador de Waterpolo</h1>
            <p class="subtitle">Controla el marcador, tiempos muertos y temporizadores para partidos de waterpolo</p>
            <div class="controls">
                <button class="btn btn-primary" id="publicViewBtn">
                    <i class="fas fa-tv"></i> Abrir Vista Pública
                </button>
                <button class="btn btn-primary" id="possessionWindowBtn">
                    <i class="fas fa-stopwatch"></i> Abrir Temporizador de Posesión
                </button>
                <button class="btn btn-warning" id="resetAllBtn">
                    <i class="fas fa-redo"></i> Reiniciar Todo
                </button>
            </div>
        </header>
        
        <div class="main-content">
            <!-- Equipo Local -->
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-home"></i> Equipo Local</h2>
                
                <div class="team-header">
                    <div class="team-logo" id="localLogo">
                        <i class="fas fa-swimmer logo-placeholder"></i>
                    </div>
                    <div class="team-name" id="localName">LOCAL</div>
                </div>
                
                <div class="score-section">
                    <div class="score" id="localScore">0</div>
                    <div class="score-controls">
                        <button class="score-btn" id="localMinus">-</button>
                        <button class="score-btn" id="localPlus">+</button>
                    </div>
                </div>
                
                <div class="timeouts-section">
                    <div class="timeouts-title">Tiempos Muertos</div>
                    <div class="timeouts-controls">
                        <div class="timeout-box" id="localTimeout1">1</div>
                        <div class="timeout-box" id="localTimeout2">2</div>
                    </div>
                    <div class="edit-timeout-controls">
                        <button class="edit-timeout-btn" id="localTimeoutAdd">
                            <i class="fas fa-plus"></i>
                        </button>
                        <span>Usados: <span id="localTimeoutsUsed">0</span>/2</span>
                        <button class="edit-timeout-btn" id="localTimeoutRemove">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                
                <div class="edit-team-form">
                    <input type="text" class="edit-input" id="localNameInput" placeholder="Nombre del equipo local">
                    <input type="text" class="edit-input" id="localLogoInput" placeholder="URL del escudo (opcional)">
                    <button class="btn btn-primary" id="saveLocalBtn">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                </div>
            </div>
            
            <!-- Equipo Visitante -->
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-plane-departure"></i> Equipo Visitante</h2>
                
                <div class="team-header">
                    <div class="team-logo" id="visitorLogo">
                        <i class="fas fa-water logo-placeholder"></i>
                    </div>
                    <div class="team-name" id="visitorName">VISITANTE</div>
                </div>
                
                <div class="score-section">
                    <div class="score" id="visitorScore">0</div>
                    <div class="score-controls">
                        <button class="score-btn" id="visitorMinus">-</button>
                        <button class="score-btn" id="visitorPlus">+</button>
                    </div>
                </div>
                
                <div class="timeouts-section">
                    <div class="timeouts-title">Tiempos Muertos</div>
                    <div class="timeouts-controls">
                        <div class="timeout-box" id="visitorTimeout1">1</div>
                        <div class="timeout-box" id="visitorTimeout2">2</div>
                    </div>
                    <div class="edit-timeout-controls">
                        <button class="edit-timeout-btn" id="visitorTimeoutAdd">
                            <i class="fas fa-plus"></i>
                        </button>
                        <span>Usados: <span id="visitorTimeoutsUsed">0</span>/2</span>
                        <button class="edit-timeout-btn" id="visitorTimeoutRemove">
                            <i class="fas fa-minus"></i>
                        </button>
                    </div>
                </div>
                
                <div class="edit-team-form">
                    <input type="text" class="edit-input" id="visitorNameInput" placeholder="Nombre del equipo visitante">
                    <input type="text" class="edit-input" id="visitorLogoInput" placeholder="URL del escudo (opcional)">
                    <button class="btn btn-primary" id="saveVisitorBtn">
                        <i class="fas fa-save"></i> Guardar Cambios
                    </button>
                </div>
            </div>
            
            <!-- Temporizador de Posesión -->
            <div class="panel">
                <h2 class="panel-title"><i class="fas fa-stopwatch"></i> Posesión</h2>
                <div class="timer-display" id="possessionDisplay">30</div>
                
                <div class="timer-controls">
                    <button class="btn btn-primary" id="startPossessionBtn">
                        <i class="fas fa-play"></i> Iniciar
                    </button>
                    <button class="btn btn-secondary" id="pausePossessionBtn">
                        <i class="fas fa-pause"></i> Pausar
                    </button>
                    <button class="btn btn-success" id="resetPossessionBtn">
                        <i class="fas fa-redo"></i> Reiniciar
                    </button>
                </div>
                
                <div class="timer-presets">
                    <button class="timer-preset-btn active" id="preset30">30 segundos</button>
                    <button class="timer-preset-btn" id="preset20">20 segundos</button>
                </div>
                
                <div style="margin-top: 20px;">
                    <span>Tiempo personalizado:</span>
                    <input type="number" class="edit-time-input" id="possessionCustomTime" min="5" max="60" value="30">
                    <span>segundos</span>
                    <button class="btn btn-primary" id="setPossessionTime" style="margin-left: 10px;">
                        <i class="fas fa-check"></i> Aplicar
                    </button>
                </div>
            </div>
            
            <!-- Cronómetro General -->
            <div class="panel general-timer">
                <h2 class="panel-title"><i class="fas fa-clock"></i> Cronómetro del Partido</h2>
                <div class="timer-display" id="gameTimerDisplay">08:00</div>
                
                <div class="general-timer-controls">
                    <button class="btn btn-primary" id="startGameTimerBtn">
                        <i class="fas fa-play"></i> Iniciar
                    </button>
                    <button class="btn btn-secondary" id="pauseGameTimerBtn">
                        <i class="fas fa-pause"></i> Pausar
                    </button>
                    <button class="btn btn-success" id="resetGameTimerBtn">
                        <i class="fas fa-redo"></i> Reiniciar
                    </button>
                </div>
                
                <div class="period-control">
                    <button class="btn btn-warning" id="prevPeriodBtn">
                        <i class="fas fa-chevron-left"></i> Anterior
                    </button>
                    <div class="period-display" id="periodDisplay">PERIODO 1</div>
                    <button class="btn btn-warning" id="nextPeriodBtn">
                        <i class="fas fa-chevron-right"></i> Siguiente
                    </button>
                </div>
                
                <div style="margin-top: 20px;">
                    <span>Duración del periodo:</span>
                    <input type="number" class="edit-time-input" id="periodDuration" min="1" max="20" value="8">
                    <span>minutos</span>
                    <button class="btn btn-primary" id="setPeriodDuration" style="margin-left: 10px;">
                        <i class="fas fa-check"></i> Aplicar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let localScore = 0;
        let visitorScore = 0;
        let localTimeoutsUsed = 0;
        let visitorTimeoutsUsed = 0;
        let possessionTime = 30;
        let possessionTimerInterval = null;
        let isPossessionRunning = false;
        let gameTimerTime = 8 * 60; // 8 minutos en segundos
        let gameTimerInterval = null;
        let isGameTimerRunning = false;
        let currentPeriod = 1;
        let periodDuration = 8; // minutos
        
        // Ventanas abiertas
        let publicViewWindow = null;
        let possessionWindow = null;

        // Elementos del DOM
        const localScoreEl = document.getElementById('localScore');
        const visitorScoreEl = document.getElementById('visitorScore');
        const localTimeoutsUsedEl = document.getElementById('localTimeoutsUsed');
        const visitorTimeoutsUsedEl = document.getElementById('visitorTimeoutsUsed');
        const possessionDisplayEl = document.getElementById('possessionDisplay');
        const gameTimerDisplayEl = document.getElementById('gameTimerDisplay');
        const periodDisplayEl = document.getElementById('periodDisplay');
        
        // Inicializar la aplicación
        function init() {
            // Cargar datos guardados si existen
            loadSavedData();
            
            // Configurar eventos
            setupEventListeners();
            
            // Actualizar la interfaz
            updateScores();
            updateTimeouts();
            updatePossessionDisplay();
            updateGameTimerDisplay();
            updatePeriodDisplay();
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Marcador local
            document.getElementById('localPlus').addEventListener('click', () => {
                localScore++;
                updateScores();
                saveData();
                broadcastData();
            });
            
            document.getElementById('localMinus').addEventListener('click', () => {
                if (localScore > 0) localScore--;
                updateScores();
                saveData();
                broadcastData();
            });
            
            // Marcador visitante
            document.getElementById('visitorPlus').addEventListener('click', () => {
                visitorScore++;
                updateScores();
                saveData();
                broadcastData();
            });
            
            document.getElementById('visitorMinus').addEventListener('click', () => {
                if (visitorScore > 0) visitorScore--;
                updateScores();
                saveData();
                broadcastData();
            });
            
            // Tiempos muertos locales
            document.getElementById('localTimeoutAdd').addEventListener('click', () => {
                if (localTimeoutsUsed < 2) {
                    localTimeoutsUsed++;
                    updateTimeouts();
                    saveData();
                    broadcastData();
                }
            });
            
            document.getElementById('localTimeoutRemove').addEventListener('click', () => {
                if (localTimeoutsUsed > 0) {
                    localTimeoutsUsed--;
                    updateTimeouts();
                    saveData();
                    broadcastData();
                }
            });
            
            // Tiempos muertos visitantes
            document.getElementById('visitorTimeoutAdd').addEventListener('click', () => {
                if (visitorTimeoutsUsed < 2) {
                    visitorTimeoutsUsed++;
                    updateTimeouts();
                    saveData();
                    broadcastData();
                }
            });
            
            document.getElementById('visitorTimeoutRemove').addEventListener('click', () => {
                if (visitorTimeoutsUsed > 0) {
                    visitorTimeoutsUsed--;
                    updateTimeouts();
                    saveData();
                    broadcastData();
                }
            });
            
            // Temporizador de posesión
            document.getElementById('startPossessionBtn').addEventListener('click', startPossessionTimer);
            document.getElementById('pausePossessionBtn').addEventListener('click', pausePossessionTimer);
            document.getElementById('resetPossessionBtn').addEventListener('click', resetPossessionTimer);
            
            // Presets del temporizador de posesión
            document.getElementById('preset30').addEventListener('click', () => setPossessionPreset(30));
            document.getElementById('preset20').addEventListener('click', () => setPossessionPreset(20));
            document.getElementById('setPossessionTime').addEventListener('click', setCustomPossessionTime);
            document.getElementById('possessionCustomTime').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') setCustomPossessionTime();
            });
            
            // Cronómetro general
            document.getElementById('startGameTimerBtn').addEventListener('click', startGameTimer);
            document.getElementById('pauseGameTimerBtn').addEventListener('click', pauseGameTimer);
            document.getElementById('resetGameTimerBtn').addEventListener('click', resetGameTimer);
            document.getElementById('setPeriodDuration').addEventListener('click', setGameTimerDuration);
            document.getElementById('periodDuration').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') setGameTimerDuration();
            });
            
            // Periodos
            document.getElementById('prevPeriodBtn').addEventListener('click', prevPeriod);
            document.getElementById('nextPeriodBtn').addEventListener('click', nextPeriod);
            
            // Botones de control
            document.getElementById('publicViewBtn').addEventListener('click', openPublicView);
            document.getElementById('possessionWindowBtn').addEventListener('click', openPossessionWindow);
            document.getElementById('resetAllBtn').addEventListener('click', resetAll);
            
            // Guardar equipos
            document.getElementById('saveLocalBtn').addEventListener('click', saveLocalTeam);
            document.getElementById('saveVisitorBtn').addEventListener('click', saveVisitorTeam);
            
            // Permitir Enter en campos de entrada
            document.getElementById('localNameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') saveLocalTeam();
            });
            
            document.getElementById('visitorNameInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') saveVisitorTeam();
            });
            
            // Escuchar cambios en localStorage para sincronización
            window.addEventListener('storage', handleStorageChange);
            
            // Sincronizar periódicamente
            setInterval(broadcastData, 1000);
        }

        // Actualizar marcadores
        function updateScores() {
            localScoreEl.textContent = localScore;
            visitorScoreEl.textContent = visitorScore;
        }

        // Actualizar tiempos muertos
        function updateTimeouts() {
            // Actualizar contadores
            localTimeoutsUsedEl.textContent = localTimeoutsUsed;
            visitorTimeoutsUsedEl.textContent = visitorTimeoutsUsed;
            
            // Actualizar cajas de tiempos muertos locales
            const localTimeout1 = document.getElementById('localTimeout1');
            const localTimeout2 = document.getElementById('localTimeout2');
            
            localTimeout1.className = 'timeout-box';
            localTimeout2.className = 'timeout-box';
            
            if (localTimeoutsUsed >= 1) localTimeout1.classList.add('timeout-used');
            if (localTimeoutsUsed >= 2) localTimeout2.classList.add('timeout-used');
            
            // Actualizar cajas de tiempos muertos visitantes
            const visitorTimeout1 = document.getElementById('visitorTimeout1');
            const visitorTimeout2 = document.getElementById('visitorTimeout2');
            
            visitorTimeout1.className = 'timeout-box';
            visitorTimeout2.className = 'timeout-box';
            
            if (visitorTimeoutsUsed >= 1) visitorTimeout1.classList.add('timeout-used');
            if (visitorTimeoutsUsed >= 2) visitorTimeout2.classList.add('timeout-used');
        }

        // Temporizador de posesión
        function startPossessionTimer() {
            if (isPossessionRunning) return;
            
            isPossessionRunning = true;
            document.getElementById('startPossessionBtn').disabled = true;
            document.getElementById('pausePossessionBtn').disabled = false;
            
            const startTime = Date.now();
            const endTime = startTime + (possessionTime * 1000);
            
            possessionTimerInterval = setInterval(() => {
                const now = Date.now();
                const remaining = Math.max(0, endTime - now);
                
                const seconds = Math.ceil(remaining / 1000);
                possessionDisplayEl.textContent = seconds;
                
                // Cambiar color cuando queden 5 segundos o menos
                if (seconds <= 5) {
                    possessionDisplayEl.style.color = '#ff6b6b';
                } else {
                    possessionDisplayEl.style.color = '#4ecdc4';
                }
                
                // Cuando llegue a cero
                if (remaining <= 0) {
                    clearInterval(possessionTimerInterval);
                    isPossessionRunning = false;
                    document.getElementById('startPossessionBtn').disabled = false;
                    document.getElementById('pausePossessionBtn').disabled = true;
                    
                    // Reproducir sonido de alarma
                    playBeepSound();
                }
                
                // Sincronizar con ventana de posesión
                broadcastPossessionTimer(seconds, isPossessionRunning);
            }, 100);
            
            // Sincronizar inicio
            broadcastPossessionTimer(possessionTime, true);
        }

        function pausePossessionTimer() {
            if (!isPossessionRunning) return;
            
            clearInterval(possessionTimerInterval);
            isPossessionRunning = false;
            document.getElementById('startPossessionBtn').disabled = false;
            document.getElementById('pausePossessionBtn').disabled = true;
            
            // Sincronizar pausa
            broadcastPossessionTimer(parseInt(possessionDisplayEl.textContent), false);
        }

        function resetPossessionTimer() {
            clearInterval(possessionTimerInterval);
            isPossessionRunning = false;
            document.getElementById('startPossessionBtn').disabled = false;
            document.getElementById('pausePossessionBtn').disabled = true;
            possessionDisplayEl.style.color = '#4ecdc4';
            updatePossessionDisplay();
            
            // Sincronizar reinicio
            broadcastPossessionTimer(possessionTime, false);
        }

        function setPossessionPreset(seconds) {
            possessionTime = seconds;
            document.getElementById('possessionCustomTime').value = seconds;
            
            // Actualizar botones activos
            if (seconds === 30) {
                document.getElementById('preset30').classList.add('active');
                document.getElementById('preset20').classList.remove('active');
            } else {
                document.getElementById('preset30').classList.remove('active');
                document.getElementById('preset20').classList.add('active');
            }
            
            resetPossessionTimer();
            saveData();
            broadcastData();
        }

        function setCustomPossessionTime() {
            const customTime = parseInt(document.getElementById('possessionCustomTime').value);
            if (customTime >= 5 && customTime <= 60) {
                setPossessionPreset(customTime);
            } else {
                alert('Por favor, introduce un valor entre 5 y 60 segundos.');
                document.getElementById('possessionCustomTime').value = possessionTime;
            }
        }

        function updatePossessionDisplay() {
            possessionDisplayEl.textContent = possessionTime;
        }

        // Cronómetro general del partido
        function startGameTimer() {
            if (isGameTimerRunning) return;
            
            isGameTimerRunning = true;
            document.getElementById('startGameTimerBtn').disabled = true;
            document.getElementById('pauseGameTimerBtn').disabled = false;
            
            const startTime = Date.now();
            const endTime = startTime + (gameTimerTime * 1000);
            
            gameTimerInterval = setInterval(() => {
                const now = Date.now();
                const remaining = Math.max(0, endTime - now);
                
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                
                gameTimerDisplayEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Cuando llegue a cero
                if (remaining <= 0) {
                    clearInterval(gameTimerInterval);
                    isGameTimerRunning = false;
                    document.getElementById('startGameTimerBtn').disabled = false;
                    document.getElementById('pauseGameTimerBtn').disabled = true;
                    
                    // Reproducir sonido de alarma
                    playBeepSound();
                }
            }, 100);
        }

        function pauseGameTimer() {
            if (!isGameTimerRunning) return;
            
            clearInterval(gameTimerInterval);
            
            // Calcular el tiempo restante
            const currentTime = gameTimerDisplayEl.textContent;
            const [minutes, seconds] = currentTime.split(':').map(Number);
            gameTimerTime = minutes * 60 + seconds;
            
            isGameTimerRunning = false;
            document.getElementById('startGameTimerBtn').disabled = false;
            document.getElementById('pauseGameTimerBtn').disabled = true;
        }

        function resetGameTimer() {
            clearInterval(gameTimerInterval);
            isGameTimerRunning = false;
            document.getElementById('startGameTimerBtn').disabled = false;
            document.getElementById('pauseGameTimerBtn').disabled = true;
            
            // Restablecer al tiempo del periodo
            gameTimerTime = periodDuration * 60;
            updateGameTimerDisplay();
        }

        function setGameTimerDuration() {
            const duration = parseInt(document.getElementById('periodDuration').value);
            if (duration >= 1 && duration <= 20) {
                periodDuration = duration;
                gameTimerTime = duration * 60;
                updateGameTimerDisplay();
                saveData();
                broadcastData();
            } else {
                alert('Por favor, introduce un valor entre 1 y 20 minutos.');
                document.getElementById('periodDuration').value = periodDuration;
            }
        }

        function updateGameTimerDisplay() {
            const minutes = Math.floor(gameTimerTime / 60);
            const seconds = gameTimerTime % 60;
            gameTimerDisplayEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Control de periodos
        function prevPeriod() {
            if (currentPeriod > 1) {
                currentPeriod--;
                updatePeriodDisplay();
                saveData();
                broadcastData();
            }
        }

        function nextPeriod() {
            if (currentPeriod < 4) {
                currentPeriod++;
                updatePeriodDisplay();
                saveData();
                broadcastData();
            }
        }

        function updatePeriodDisplay() {
            periodDisplayEl.textContent = `PERIODO ${currentPeriod}`;
        }

        // Abrir vista pública
        function openPublicView() {
            if (publicViewWindow && !publicViewWindow.closed) {
                publicViewWindow.focus();
                return;
            }
            
            publicViewWindow = window.open('', 'PublicViewWindow', 'width=800,height=600,left=100,top=100');
            
            if (publicViewWindow) {
                const publicViewHTML = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Marcador de Waterpolo - Vista Pública</title>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
                        <style>
                            * {
                                margin: 0;
                                padding: 0;
                                box-sizing: border-box;
                                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                            }
                            
                            body {
                                background: linear-gradient(135deg, #0a2463 0%, #1a3d7a 100%);
                                color: white;
                                height: 100vh;
                                display: flex;
                                flex-direction: column;
                                padding: 20px;
                            }
                            
                            .header {
                                text-align: center;
                                padding: 20px;
                                background-color: rgba(0, 30, 80, 0.8);
                                border-radius: 15px;
                                margin-bottom: 30px;
                                border: 2px solid rgba(255, 255, 255, 0.1);
                            }
                            
                            .title {
                                font-size: 2.5rem;
                                margin-bottom: 10px;
                                color: #ffd166;
                            }
                            
                            .scoreboard {
                                display: flex;
                                justify-content: space-between;
                                align-items: center;
                                margin-bottom: 30px;
                                flex-grow: 1;
                            }
                            
                            .team {
                                text-align: center;
                                flex: 1;
                                padding: 20px;
                            }
                            
                            .team-logo {
                                width: 150px;
                                height: 150px;
                                margin: 0 auto 20px;
                                background-color: rgba(255, 255, 255, 0.2);
                                border-radius: 50%;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-size: 4rem;
                                color: white;
                                border: 5px solid rgba(255, 255, 255, 0.3);
                                overflow: hidden;
                            }
                            
                            .logo-img {
                                width: 100%;
                                height: 100%;
                                object-fit: cover;
                            }
                            
                            .team-name {
                                font-size: 2.5rem;
                                font-weight: bold;
                                margin-bottom: 20px;
                                color: white;
                            }
                            
                            .team-score {
                                font-size: 6rem;
                                font-weight: 800;
                                color: #ffd166;
                                text-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
                            }
                            
                            .timeouts {
                                display: flex;
                                justify-content: center;
                                gap: 20px;
                                margin-top: 20px;
                            }
                            
                            .timeout-dot {
                                width: 40px;
                                height: 40px;
                                border-radius: 50%;
                                background-color: rgba(255, 255, 255, 0.2);
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                font-weight: bold;
                                font-size: 1.2rem;
                            }
                            
                            .timeout-used {
                                background-color: #ff6b6b;
                            }
                            
                            .center-info {
                                text-align: center;
                                padding: 0 40px;
                            }
                            
                            .game-timer {
                                font-size: 4.5rem;
                                font-weight: 800;
                                color: #4ecdc4;
                                margin-bottom: 20px;
                                font-family: 'Courier New', monospace;
                            }
                            
                            .period {
                                font-size: 2rem;
                                font-weight: bold;
                                color: #ffd166;
                                background-color: rgba(255, 255, 255, 0.1);
                                padding: 10px 30px;
                                border-radius: 50px;
                                display: inline-block;
                            }
                            
                            .possession-timer-container {
                                margin-top: 30px;
                                padding: 20px;
                                background-color: rgba(0, 0, 0, 0.3);
                                border-radius: 15px;
                                border: 2px solid rgba(255, 255, 255, 0.1);
                            }
                            
                            .possession-title {
                                font-size: 1.5rem;
                                margin-bottom: 10px;
                                color: #ffd166;
                            }
                            
                            .possession-timer {
                                font-size: 3.5rem;
                                font-weight: 800;
                                color: #4ecdc4;
                                font-family: 'Courier New', monospace;
                            }
                            
                            .footer {
                                text-align: center;
                                padding: 15px;
                                margin-top: 20px;
                                font-size: 1rem;
                                color: rgba(255, 255, 255, 0.7);
                                border-top: 1px solid rgba(255, 255, 255, 0.1);
                            }
                        </style>
                    </head>
                    <body>
                        <div class="header">
                            <h1 class="title"><i class="fas fa-water"></i> WATERPOLO - EN DIRECTO</h1>
                        </div>
                        
                        <div class="scoreboard">
                            <div class="team" id="publicLocalTeam">
                                <div class="team-logo" id="publicLocalLogo">
                                    <i class="fas fa-swimmer"></i>
                                </div>
                                <div class="team-name" id="publicLocalName">LOCAL</div>
                                <div class="team-score" id="publicLocalScore">0</div>
                                <div class="timeouts" id="publicLocalTimeouts">
                                    <div class="timeout-dot">1</div>
                                    <div class="timeout-dot">2</div>
                                </div>
                            </div>
                            
                            <div class="center-info">
                                <div class="game-timer" id="publicGameTimer">08:00</div>
                                <div class="period" id="publicPeriod">PERIODO 1</div>
                                
                                <div class="possession-timer-container">
                                    <div class="possession-title">TIEMPO DE POSESIÓN</div>
                                    <div class="possession-timer" id="publicPossessionTimer">30</div>
                                </div>
                            </div>
                            
                            <div class="team" id="publicVisitorTeam">
                                <div class="team-logo" id="publicVisitorLogo">
                                    <i class="fas fa-water"></i>
                                </div>
                                <div class="team-name" id="publicVisitorName">VISITANTE</div>
                                <div class="team-score" id="publicVisitorScore">0</div>
                                <div class="timeouts" id="publicVisitorTimeouts">
                                    <div class="timeout-dot">1</div>
                                    <div class="timeout-dot">2</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="footer">
                            Marcador de Waterpolo - Actualizado en tiempo real
                        </div>
                        
                        <script>
                            // Función para actualizar la vista pública con datos
                            function updatePublicView(data) {
                                if (data.localScore !== undefined) {
                                    document.getElementById('publicLocalScore').textContent = data.localScore;
                                }
                                
                                if (data.visitorScore !== undefined) {
                                    document.getElementById('publicVisitorScore').textContent = data.visitorScore;
                                }
                                
                                if (data.localName !== undefined) {
                                    document.getElementById('publicLocalName').textContent = data.localName;
                                }
                                
                                if (data.visitorName !== undefined) {
                                    document.getElementById('publicVisitorName').textContent = data.visitorName;
                                }
                                
                                if (data.localLogo !== undefined) {
                                    document.getElementById('publicLocalLogo').innerHTML = data.localLogo;
                                }
                                
                                if (data.visitorLogo !== undefined) {
                                    document.getElementById('publicVisitorLogo').innerHTML = data.visitorLogo;
                                }
                                
                                if (data.localTimeoutsUsed !== undefined) {
                                    const timeouts = document.querySelectorAll('#publicLocalTimeouts .timeout-dot');
                                    timeouts.forEach((dot, index) => {
                                        dot.className = 'timeout-dot';
                                        if (index < data.localTimeoutsUsed) {
                                            dot.classList.add('timeout-used');
                                        }
                                    });
                                }
                                
                                if (data.visitorTimeoutsUsed !== undefined) {
                                    const timeouts = document.querySelectorAll('#publicVisitorTimeouts .timeout-dot');
                                    timeouts.forEach((dot, index) => {
                                        dot.className = 'timeout-dot';
                                        if (index < data.visitorTimeoutsUsed) {
                                            dot.classList.add('timeout-used');
                                        }
                                    });
                                }
                                
                                if (data.gameTimerDisplay !== undefined) {
                                    document.getElementById('publicGameTimer').textContent = data.gameTimerDisplay;
                                }
                                
                                if (data.periodDisplay !== undefined) {
                                    document.getElementById('publicPeriod').textContent = data.periodDisplay;
                                }
                                
                                if (data.possessionDisplay !== undefined) {
                                    document.getElementById('publicPossessionTimer').textContent = data.possessionDisplay;
                                    // Cambiar color cuando queden 5 segundos o menos
                                    if (parseInt(data.possessionDisplay) <= 5) {
                                        document.getElementById('publicPossessionTimer').style.color = '#ff6b6b';
                                    } else {
                                        document.getElementById('publicPossessionTimer').style.color = '#4ecdc4';
                                    }
                                }
                            }
                            
                            // Escuchar mensajes del panel de control
                            window.addEventListener('storage', function(e) {
                                if (e.key === 'waterpolo_public_data' && e.newValue) {
                                    const data = JSON.parse(e.newValue);
                                    updatePublicView(data);
                                }
                            });
                            
                            // Cargar datos iniciales
                            const initialData = localStorage.getItem('waterpolo_public_data');
                            if (initialData) {
                                updatePublicView(JSON.parse(initialData));
                            }
                            
                            // Actualizar desde la ventana principal periódicamente
                            setInterval(() => {
                                if (window.opener && !window.opener.closed) {
                                    try {
                                        const data = {
                                            localScore: window.opener.localScore,
                                            visitorScore: window.opener.visitorScore,
                                            localName: window.opener.document.getElementById('localName').textContent,
                                            visitorName: window.opener.document.getElementById('visitorName').textContent,
                                            localTimeoutsUsed: window.opener.localTimeoutsUsed,
                                            visitorTimeoutsUsed: window.opener.visitorTimeoutsUsed,
                                            gameTimerDisplay: window.opener.document.getElementById('gameTimerDisplay').textContent,
                                            periodDisplay: window.opener.document.getElementById('periodDisplay').textContent,
                                            possessionDisplay: window.opener.document.getElementById('possessionDisplay').textContent
                                        };
                                        updatePublicView(data);
                                    } catch(e) {
                                        // Acceso cruzado no permitido
                                    }
                                }
                            }, 500);
                        <\/script>
                    </body>
                    </html>
                `;
                
                publicViewWindow.document.write(publicViewHTML);
                publicViewWindow.document.close();
                
                // Enviar datos iniciales
                setTimeout(() => broadcastData(), 500);
            } else {
                alert('Por favor, permite ventanas emergentes para esta función.');
            }
        }

        // Abrir ventana de temporizador de posesión
        function openPossessionWindow() {
            if (possessionWindow && !possessionWindow.closed) {
                possessionWindow.focus();
                return;
            }
            
            possessionWindow = window.open('', 'PossessionWindow', 'width=400,height=300,left=100,top=100');
            
            if (possessionWindow) {
                const possessionWindowHTML = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Temporizador de Posesión</title>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <style>
                            body {
                                background: linear-gradient(135deg, #0a2463 0%, #1a3d7a 100%);
                                color: white;
                                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                                display: flex;
                                flex-direction: column;
                                align-items: center;
                                justify-content: center;
                                height: 100vh;
                                margin: 0;
                                padding: 20px;
                                text-align: center;
                            }
                            
                            .title {
                                font-size: 2rem;
                                margin-bottom: 20px;
                                color: #ffd166;
                            }
                            
                            .timer {
                                font-size: 6rem;
                                font-weight: 800;
                                color: #4ecdc4;
                                margin: 20px 0;
                                text-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
                                font-family: 'Courier New', monospace;
                                min-height: 100px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            }
                            
                            .status {
                                font-size: 1.2rem;
                                margin-top: 20px;
                                color: rgba(255, 255, 255, 0.8);
                                padding: 10px 20px;
                                background-color: rgba(0, 0, 0, 0.3);
                                border-radius: 10px;
                            }
                            
                            .footer {
                                position: absolute;
                                bottom: 15px;
                                font-size: 0.9rem;
                                color: rgba(255, 255, 255, 0.6);
                            }
                        </style>
                    </head>
                    <body>
                        <div class="title">TIEMPO DE POSESIÓN</div>
                        <div class="timer" id="possessionTimer">${possessionTime}</div>
                        <div class="status" id="possessionStatus">DETENIDO</div>
                        <div class="footer">Sincronizado con el panel de control</div>
                        
                        <script>
                            // Actualizar el temporizador
                            function updatePossessionTimer(seconds, isRunning) {
                                const timerEl = document.getElementById('possessionTimer');
                                const statusEl = document.getElementById('possessionStatus');
                                
                                timerEl.textContent = seconds;
                                
                                // Cambiar color cuando queden 5 segundos o menos
                                if (seconds <= 5) {
                                    timerEl.style.color = '#ff6b6b';
                                } else {
                                    timerEl.style.color = '#4ecdc4';
                                }
                                
                                // Actualizar estado
                                statusEl.textContent = isRunning ? 'EN MARCHA' : 'DETENIDO';
                                statusEl.style.backgroundColor = isRunning ? 'rgba(78, 205, 196, 0.3)' : 'rgba(255, 107, 107, 0.3)';
                            }
                            
                            // Escuchar mensajes del panel de control
                            window.addEventListener('storage', function(e) {
                                if (e.key === 'waterpolo_possession' && e.newValue) {
                                    const data = JSON.parse(e.newValue);
                                    updatePossessionTimer(data.seconds, data.isRunning);
                                }
                            });
                            
                            // Cargar estado inicial
                            const initialData = localStorage.getItem('waterpolo_possession');
                            if (initialData) {
                                const data = JSON.parse(initialData);
                                updatePossessionTimer(data.seconds, data.isRunning);
                            }
                            
                            // Actualizar desde la ventana principal periódicamente
                            setInterval(() => {
                                if (window.opener && !window.opener.closed) {
                                    try {
                                        const seconds = parseInt(window.opener.document.getElementById('possessionDisplay').textContent);
                                        const isRunning = window.opener.isPossessionRunning;
                                        updatePossessionTimer(seconds, isRunning);
                                    } catch(e) {
                                        // Acceso cruzado no permitido
                                    }
                                }
                            }, 500);
                        <\/script>
                    </body>
                    </html>
                `;
                
                possessionWindow.document.write(possessionWindowHTML);
                possessionWindow.document.close();
                
                // Enviar datos iniciales
                setTimeout(() => broadcastPossessionTimer(possessionTime, isPossessionRunning), 500);
            } else {
                alert('Por favor, permite ventanas emergentes para esta función.');
            }
        }

        // Transmitir datos a las ventanas
        function broadcastData() {
            const data = {
                localScore,
                visitorScore,
                localName: document.getElementById('localName').textContent,
                visitorName: document.getElementById('visitorName').textContent,
                localLogo: document.getElementById('localLogo').innerHTML,
                visitorLogo: document.getElementById('visitorLogo').innerHTML,
                localTimeoutsUsed,
                visitorTimeoutsUsed,
                gameTimerDisplay: gameTimerDisplayEl.textContent,
                periodDisplay: periodDisplayEl.textContent,
                possessionDisplay: possessionDisplayEl.textContent
            };
            
            localStorage.setItem('waterpolo_public_data', JSON.stringify(data));
        }

        // Transmitir temporizador de posesión
        function broadcastPossessionTimer(seconds, isRunning) {
            const data = { seconds, isRunning };
            localStorage.setItem('waterpolo_possession', JSON.stringify(data));
        }

        // Manejar cambios en localStorage
        function handleStorageChange(e) {
            if (e.key === 'waterpolo_public_data' && e.newValue) {
                // Los datos ya están actualizados en la ventana principal
            } else if (e.key === 'waterpolo_possession' && e.newValue) {
                // Los datos del temporizador ya están actualizados
            }
        }

        // Reiniciar todo
        function resetAll() {
            if (confirm('¿Estás seguro de que quieres reiniciar todo? Se perderán los datos del partido actual.')) {
                localScore = 0;
                visitorScore = 0;
                localTimeoutsUsed = 0;
                visitorTimeoutsUsed = 0;
                setPossessionPreset(30);
                resetGameTimer();
                currentPeriod = 1;
                updatePeriodDisplay();
                
                updateScores();
                updateTimeouts();
                saveData();
                broadcastData();
            }
        }

        // Guardar equipo local
        function saveLocalTeam() {
            const name = document.getElementById('localNameInput').value.trim();
            const logoUrl = document.getElementById('localLogoInput').value.trim();
            
            if (name) {
                document.getElementById('localName').textContent = name;
            }
            
            if (logoUrl) {
                document.getElementById('localLogo').innerHTML = `<img src="${logoUrl}" alt="${name}" class="logo-img">`;
            } else {
                document.getElementById('localLogo').innerHTML = '<i class="fas fa-swimmer logo-placeholder"></i>';
            }
            
            saveData();
            broadcastData();
        }

        // Guardar equipo visitante
        function saveVisitorTeam() {
            const name = document.getElementById('visitorNameInput').value.trim();
            const logoUrl = document.getElementById('visitorLogoInput').value.trim();
            
            if (name) {
                document.getElementById('visitorName').textContent = name;
            }
            
            if (logoUrl) {
                document.getElementById('visitorLogo').innerHTML = `<img src="${logoUrl}" alt="${name}" class="logo-img">`;
            } else {
                document.getElementById('visitorLogo').innerHTML = '<i class="fas fa-water logo-placeholder"></i>';
            }
            
            saveData();
            broadcastData();
        }

        // Reproducir sonido de beep
        function playBeepSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start();
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch(e) {
                console.log("No se pudo reproducir sonido");
            }
        }

        // Guardar datos en localStorage
        function saveData() {
            const data = {
                localScore,
                visitorScore,
                localTimeoutsUsed,
                visitorTimeoutsUsed,
                possessionTime,
                gameTimerTime,
                isGameTimerRunning,
                currentPeriod,
                periodDuration,
                localName: document.getElementById('localName').textContent,
                visitorName: document.getElementById('visitorName').textContent,
                localLogo: document.getElementById('localLogo').innerHTML,
                visitorLogo: document.getElementById('visitorLogo').innerHTML,
                localNameInput: document.getElementById('localNameInput').value,
                visitorNameInput: document.getElementById('visitorNameInput').value,
                localLogoInput: document.getElementById('localLogoInput').value,
                visitorLogoInput: document.getElementById('visitorLogoInput').value
            };
            
            localStorage.setItem('waterpolo_control_panel', JSON.stringify(data));
        }

        // Cargar datos guardados
        function loadSavedData() {
            const savedData = localStorage.getItem('waterpolo_control_panel');
            
            if (savedData) {
                const data = JSON.parse(savedData);
                
                localScore = data.localScore || 0;
                visitorScore = data.visitorScore || 0;
                localTimeoutsUsed = data.localTimeoutsUsed || 0;
                visitorTimeoutsUsed = data.visitorTimeoutsUsed || 0;
                possessionTime = data.possessionTime || 30;
                gameTimerTime = data.gameTimerTime || 8 * 60;
                isGameTimerRunning = data.isGameTimerRunning || false;
                currentPeriod = data.currentPeriod || 1;
                periodDuration = data.periodDuration || 8;
                
                if (data.localName) {
                    document.getElementById('localName').textContent = data.localName;
                }
                
                if (data.visitorName) {
                    document.getElementById('visitorName').textContent = data.visitorName;
                }
                
                if (data.localLogo) {
                    document.getElementById('localLogo').innerHTML = data.localLogo;
                }
                
                if (data.visitorLogo) {
                    document.getElementById('visitorLogo').innerHTML = data.visitorLogo;
                }
                
                if (data.localNameInput) {
                    document.getElementById('localNameInput').value = data.localNameInput;
                }
                
                if (data.visitorNameInput) {
                    document.getElementById('visitorNameInput').value = data.visitorNameInput;
                }
                
                if (data.localLogoInput) {
                    document.getElementById('localLogoInput').value = data.localLogoInput;
                }
                
                if (data.visitorLogoInput) {
                    document.getElementById('visitorLogoInput').value = data.visitorLogoInput;
                }
                
                // Actualizar botones de preset
                if (possessionTime === 30) {
                    document.getElementById('preset30').classList.add('active');
                    document.getElementById('preset20').classList.remove('active');
                } else if (possessionTime === 20) {
                    document.getElementById('preset30').classList.remove('active');
                    document.getElementById('preset20').classList.add('active');
                } else {
                    document.getElementById('preset30').classList.remove('active');
                    document.getElementById('preset20').classList.remove('active');
                }
                
                document.getElementById('possessionCustomTime').value = possessionTime;
                document.getElementById('periodDuration').value = periodDuration;
                
                // Actualizar estado de botones del cronómetro
                if (isGameTimerRunning) {
                    document.getElementById('startGameTimerBtn').disabled = true;
                    document.getElementById('pauseGameTimerBtn').disabled = false;
                } else {
                    document.getElementById('startGameTimerBtn').disabled = false;
                    document.getElementById('pauseGameTimerBtn').disabled = true;
                }
            }
        }

        // Inicializar la aplicación cuando se cargue la página
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>